<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Completion Modules Test - SCP Project</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .status-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .status-card h2 {
      font-size: 1.2em;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-indicator.active {
      background: #10b981;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    }

    .status-indicator.inactive {
      background: #ef4444;
    }

    .status-info {
      font-size: 0.9em;
      color: #666;
      line-height: 1.6;
    }

    .action-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .action-section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .test-button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .test-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .test-button:active {
      transform: translateY(0);
    }

    .test-button.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .test-button.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .event-log {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .event-log h2 {
      color: #333;
      margin-bottom: 15px;
    }

    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      border-radius: 8px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-left: 3px solid transparent;
      border-radius: 4px;
    }

    .log-entry.completion {
      border-left-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    .log-entry.auth {
      border-left-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }

    .log-entry.error {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .timestamp {
      color: #888;
      font-size: 0.9em;
    }

    .event-name {
      color: #60a5fa;
      font-weight: bold;
    }

    .case-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .case-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-decoration: none;
      color: #333;
      position: relative;
      transition: all 0.2s;
      border: 2px solid #e5e7eb;
      cursor: pointer;
    }

    .case-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #667eea;
    }

    .case-card.completed {
      border-color: #10b981;
      background: #f0fdf4;
    }

    .case-title {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .case-specialty {
      font-size: 0.85em;
      color: #666;
    }

    .completion-badge,
    .completion-badge-incomplete {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .completion-badge {
      background: #10b981;
      color: white;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }

    .completion-badge:hover {
      background: #059669;
      transform: scale(1.1);
    }

    .completion-badge-incomplete {
      background: transparent;
      color: #d1d5db;
      border: 2px solid #d1d5db;
    }

    .completion-badge-incomplete:hover {
      color: #10b981;
      border-color: #10b981;
      transform: scale(1.1);
    }

    .stats-display {
      background: #f9fafb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: 500;
      color: #666;
    }

    .stat-value {
      font-weight: 700;
      color: #667eea;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ§ª Completion Modules Test</h1>

    <!-- System Status -->
    <div class="status-grid">
      <div class="status-card">
        <h2>
          <span class="status-indicator" id="eventBusStatus"></span>
          Event Bus
        </h2>
        <div class="status-info" id="eventBusInfo">Checking...</div>
      </div>

      <div class="status-card">
        <h2>
          <span class="status-indicator" id="firebaseStatus"></span>
          Firebase
        </h2>
        <div class="status-info" id="firebaseInfo">Checking...</div>
      </div>

      <div class="status-card">
        <h2>
          <span class="status-indicator" id="completionModuleStatus"></span>
          Completion Module
        </h2>
        <div class="status-info" id="completionModuleInfo">Checking...</div>
      </div>

      <div class="status-card">
        <h2>
          <span class="status-indicator" id="completionUIStatus"></span>
          Completion UI
        </h2>
        <div class="status-info" id="completionUIInfo">Checking...</div>
      </div>
    </div>

    <!-- Current Stats -->
    <div class="action-section">
      <h2>ðŸ“Š Current Statistics</h2>
      <div class="stats-display" id="statsDisplay">
        Loading...
      </div>
    </div>

    <!-- Test Actions -->
    <div class="action-section">
      <h2>ðŸŽ¯ Test Actions</h2>
      <div class="button-grid">
        <button class="test-button success" onclick="testMarkCompleted()">Mark Test Case Complete</button>
        <button class="test-button" onclick="testMarkIncomplete()">Mark Test Case Incomplete</button>
        <button class="test-button" onclick="testToggleCompletion()">Toggle Test Case</button>
        <button class="test-button" onclick="testExportData()">Export Data</button>
        <button class="test-button" onclick="testGetStats()">Log Stats to Console</button>
        <button class="test-button danger" onclick="testClearAll()">Clear All Data</button>
      </div>
    </div>

    <!-- Mock Case Cards -->
    <div class="action-section">
      <h2>ðŸŽ´ Test Case Cards (Click checkmarks to toggle)</h2>
      <div class="case-cards" id="caseCards">
        <!-- Cards will be generated by JS -->
      </div>
    </div>

    <!-- Event Log -->
    <div class="event-log">
      <h2>ðŸ“¡ Event Log</h2>
      <div class="log-container" id="eventLog">
        <div class="log-entry">Waiting for events...</div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- Firebase Config -->
  <script src="js/firebase-config.js"></script>

  <!-- Core Services -->
  <script src="js/core/EventBus.js"></script>
  <script src="js/core/FirebaseService.js"></script>
  <script src="js/core/App.js"></script>

  <!-- Auth Modules (needed for auth events) -->
  <script src="js/modules/auth/AuthModule.js"></script>
  <script src="js/modules/auth/AuthUI.js"></script>

  <!-- Completion Modules -->
  <script src="js/modules/progress/CompletionModule.js"></script>
  <script src="js/modules/progress/CompletionUI.js"></script>

  <!-- Test Page Logic -->
  <script>
    // Track if test page has been initialized
    let testPageInitialized = false;

    // Wait for app to initialize
    window.addEventListener('DOMContentLoaded', () => {
      console.log('Test page loaded, waiting for app initialization...');

      // Listen for app ready
      eventBus.on('app:ready', () => {
        console.log('App ready event received, setting up test page...');
        if (!testPageInitialized) {
          testPageInitialized = true;
          initializeTestPage();
        }
      });

      // Fallback: Check if app is already initialized after a delay
      setTimeout(() => {
        if (!testPageInitialized && window.app && window.app.initialized) {
          console.log('App already initialized, setting up test page (fallback)...');
          testPageInitialized = true;
          initializeTestPage();
        }
      }, 1000);

      // Also check system status immediately
      setTimeout(checkSystemStatus, 500);
    });

    function checkSystemStatus() {
      // EventBus
      const eventBusStatus = document.getElementById('eventBusStatus');
      const eventBusInfo = document.getElementById('eventBusInfo');
      if (window.eventBus) {
        eventBusStatus.className = 'status-indicator active';
        eventBusInfo.textContent = `Active - ${eventBus.getListenerCount()} total listeners`;
      } else {
        eventBusStatus.className = 'status-indicator inactive';
        eventBusInfo.textContent = 'Not loaded';
      }

      // Firebase
      const firebaseStatus = document.getElementById('firebaseStatus');
      const firebaseInfo = document.getElementById('firebaseInfo');
      if (window.firebaseService && firebaseService.isReady()) {
        firebaseStatus.className = 'status-indicator active';
        const user = firebaseService.getCurrentUser();
        firebaseInfo.textContent = user ? `Signed in as ${user.email}` : 'Ready (not signed in)';
      } else {
        firebaseStatus.className = 'status-indicator inactive';
        firebaseInfo.textContent = 'Not ready';
      }

      // CompletionModule
      const completionModuleStatus = document.getElementById('completionModuleStatus');
      const completionModuleInfo = document.getElementById('completionModuleInfo');
      if (window.app && typeof window.app.getModule === 'function' && window.app.getModule('completion')) {
        completionModuleStatus.className = 'status-indicator active';
        const stats = window.app.getModule('completion').getStats();
        completionModuleInfo.textContent = `Active - ${stats.completed} cases completed`;
      } else {
        completionModuleStatus.className = 'status-indicator inactive';
        completionModuleInfo.textContent = 'Not loaded';
      }

      // CompletionUI
      const completionUIStatus = document.getElementById('completionUIStatus');
      const completionUIInfo = document.getElementById('completionUIInfo');
      if (window.app && typeof window.app.getModule === 'function' && window.app.getModule('completionUI')) {
        completionUIStatus.className = 'status-indicator active';
        completionUIInfo.textContent = 'Active and listening to events';
      } else {
        completionUIStatus.className = 'status-indicator inactive';
        completionUIInfo.textContent = 'Not loaded';
      }

      // Update stats
      updateStatsDisplay();
    }

    function initializeTestPage() {
      console.log('Initializing test page...');

      // Set up event logging
      setupEventLogging();

      // Generate mock case cards
      generateMockCases();

      // Update status
      checkSystemStatus();

      // Update stats every second
      setInterval(updateStatsDisplay, 1000);
      setInterval(checkSystemStatus, 2000);
    }

    function setupEventLogging() {
      const logContainer = document.getElementById('eventLog');
      logContainer.innerHTML = '<div class="log-entry">Event log active...</div>';

      // Log all completion events
      const completionEvents = [
        'completion:initialized',
        'completion:loaded-from-local',
        'completion:synced',
        'completion:case-completed',
        'completion:case-uncompleted',
        'completion:data-cleared',
        'completion:data-imported',
        'completion:error'
      ];

      completionEvents.forEach(eventName => {
        eventBus.on(eventName, (data) => {
          logEvent(eventName, data, 'completion');
        });
      });

      // Log auth events too
      const authEvents = ['auth:signed-in', 'auth:signed-out', 'auth:state-change'];
      authEvents.forEach(eventName => {
        eventBus.on(eventName, (data) => {
          logEvent(eventName, data, 'auth');
        });
      });
    }

    function logEvent(eventName, data, type = 'completion') {
      const logContainer = document.getElementById('eventLog');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;

      const timestamp = new Date().toLocaleTimeString();
      const dataStr = data ? JSON.stringify(data, null, 2) : 'no data';

      entry.innerHTML = `
        <span class="timestamp">[${timestamp}]</span>
        <span class="event-name">${eventName}</span>
        <pre style="margin-top: 5px; color: #9ca3af;">${dataStr}</pre>
      `;

      logContainer.insertBefore(entry, logContainer.firstChild);

      // Keep only last 20 entries
      while (logContainer.children.length > 20) {
        logContainer.removeChild(logContainer.lastChild);
      }
    }

    function generateMockCases() {
      const container = document.getElementById('caseCards');
      const mockCases = [
        { id: '1_1', title: 'Chest Pain', specialty: 'Cardiology' },
        { id: '1_2', title: 'Shortness of Breath', specialty: 'Pulmonology' },
        { id: '2_1', title: 'Headache', specialty: 'Neurology' },
        { id: '2_2', title: 'Abdominal Pain', specialty: 'Gastroenterology' },
        { id: '3_1', title: 'Fever', specialty: 'Infectious Disease' },
        { id: '3_2', title: 'Joint Pain', specialty: 'Rheumatology' }
      ];

      container.innerHTML = '';

      mockCases.forEach(caseData => {
        const card = document.createElement('a');
        card.className = 'case-card';
        card.href = `/cases/case${caseData.id}.html`;
        card.onclick = (e) => e.preventDefault(); // Prevent navigation

        card.innerHTML = `
          <div class="case-title">${caseData.title}</div>
          <div class="case-specialty">${caseData.specialty}</div>
        `;

        container.appendChild(card);
      });

      // Update UI after generating cards
      setTimeout(() => {
        if (window.app && typeof window.app.getModule === 'function' && window.app.getModule('completionUI')) {
          window.app.getModule('completionUI').updateAllUI();
        }
      }, 100);
    }

    function updateStatsDisplay() {
      const statsDisplay = document.getElementById('statsDisplay');

      if (!window.app || typeof window.app.getModule !== 'function') {
        statsDisplay.innerHTML = '<div class="stat-item"><span class="stat-label">Status</span><span class="stat-value">App not initialized</span></div>';
        return;
      }

      const completion = window.app.getModule('completion');
      const completionUI = window.app.getModule('completionUI');

      if (!completion || !completionUI) {
        statsDisplay.innerHTML = '<div class="stat-item"><span class="stat-label">Status</span><span class="stat-value">Modules not loaded</span></div>';
        return;
      }

      const stats = completionUI.getStats();
      const completedCases = completion.getCompletedCases();

      statsDisplay.innerHTML = `
        <div class="stat-item">
          <span class="stat-label">Total Cases</span>
          <span class="stat-value">${stats.total}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Completed</span>
          <span class="stat-value">${stats.completed}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Progress</span>
          <span class="stat-value">${stats.percentage}%</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Completed IDs</span>
          <span class="stat-value">${Object.keys(completedCases).join(', ') || 'None'}</span>
        </div>
      `;
    }

    // Test functions
    function testMarkCompleted() {
      const completion = window.app.getModule('completion');
      completion.markCompleted('1_1');
      console.log('Marked case 1_1 as completed');
    }

    function testMarkIncomplete() {
      const completion = window.app.getModule('completion');
      completion.markIncomplete('1_1');
      console.log('Marked case 1_1 as incomplete');
    }

    function testToggleCompletion() {
      const completion = window.app.getModule('completion');
      completion.toggleCompletion('2_1');
      console.log('Toggled case 2_1');
    }

    function testExportData() {
      const completionUI = window.app.getModule('completionUI');
      completionUI.handleExport();
      console.log('Exported data');
    }

    function testGetStats() {
      const completionUI = window.app.getModule('completionUI');
      const stats = completionUI.getStats();
      console.log('Current stats:', stats);
      console.log('Cardiology stats:', completionUI.getStatsBySpecialty('cardiology'));
    }

    async function testClearAll() {
      const completionUI = window.app.getModule('completionUI');
      await completionUI.handleClearAll();
    }
  </script>
</body>
</html>
