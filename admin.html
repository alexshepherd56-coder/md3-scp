<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - SCP Cases</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #1a1a1a;
      color: #e0e0e0;
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
    }

    .dashboard-header h1 {
      margin: 0;
      color: white;
      font-size: 2em;
    }

    .admin-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
      color: white;
      font-weight: bold;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #b0b0b0;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #667eea;
      margin: 0;
    }

    .stat-subtext {
      font-size: 0.9em;
      color: #808080;
      margin-top: 5px;
    }

    .users-table-container {
      background: #2a2a2a;
      border-radius: 10px;
      padding: 20px;
      overflow-x: auto;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .table-header h2 {
      margin: 0;
      color: #e0e0e0;
    }

    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s;
    }

    .refresh-btn:hover {
      background: #5568d3;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table th,
    .users-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #3a3a3a;
    }

    .users-table th {
      background: #333;
      color: #b0b0b0;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 1px;
    }

    .users-table tr:hover {
      background: #333;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #808080;
      font-size: 1.2em;
    }

    .error {
      background: #ff4444;
      color: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .time-badge {
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
    }

    .online-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4CAF50;
      margin-right: 5px;
      animation: pulse 2s infinite;
    }

    .offline-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
      margin-right: 5px;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .session-details {
      font-size: 0.85em;
      color: #b0b0b0;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .filter-input {
      padding: 10px;
      border: 1px solid #3a3a3a;
      border-radius: 5px;
      background: #333;
      color: #e0e0e0;
      font-size: 1em;
    }

    .filter-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .export-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      margin-left: 10px;
    }

    .export-btn:hover {
      background: #45a049;
    }

    .auth-required {
      text-align: center;
      padding: 60px 20px;
    }

    .auth-required h2 {
      color: #667eea;
      margin-bottom: 20px;
    }

    .sign-in-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1em;
      margin-top: 20px;
    }

    .sign-in-btn:hover {
      background: #5568d3;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Firebase Configuration -->
  <script src="js/firebase-config.js"></script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Auth Required Screen -->
    <div id="authRequired" class="auth-required" style="display: none;">
      <h2>Admin Access Required</h2>
      <p>Please sign in to view the admin dashboard.</p>
      <button class="sign-in-btn" onclick="window.location.href='index.html'">Go to Sign In</button>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" style="display: none;">
      <div class="dashboard-header">
        <h1>User Analytics Dashboard</h1>
        <div class="admin-badge">ADMIN</div>
      </div>

      <div id="errorMessage" class="error" style="display: none;"></div>

      <!-- Statistics Overview -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Users</h3>
          <p class="stat-value" id="totalUsers">-</p>
          <p class="stat-subtext">Registered accounts</p>
        </div>

        <div class="stat-card">
          <h3>Active Now</h3>
          <p class="stat-value" id="activeUsers">-</p>
          <p class="stat-subtext">Currently online</p>
        </div>

        <div class="stat-card">
          <h3>Total Sessions</h3>
          <p class="stat-value" id="totalSessions">-</p>
          <p class="stat-subtext">All time</p>
        </div>

        <div class="stat-card">
          <h3>Avg Session Time</h3>
          <p class="stat-value" id="avgSessionTime">-</p>
          <p class="stat-subtext">Minutes per session</p>
        </div>
      </div>

      <!-- Users Table -->
      <div class="users-table-container">
        <div class="table-header">
          <h2>User Details</h2>
          <div>
            <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
            <button class="refresh-btn" onclick="loadDashboardData()">Refresh</button>
          </div>
        </div>

        <div class="filters">
          <input type="text" id="searchFilter" class="filter-input" placeholder="Search by email or name..." oninput="filterUsers()">
          <select id="statusFilter" class="filter-input" onchange="filterUsers()">
            <option value="all">All Users</option>
            <option value="active">Active Now</option>
            <option value="recent">Active Today</option>
          </select>
        </div>

        <div id="loadingMessage" class="loading">Loading user data...</div>

        <table class="users-table" id="usersTable" style="display: none;">
          <thead>
            <tr>
              <th>Status</th>
              <th>Email</th>
              <th>Name</th>
              <th>Last Sign In</th>
              <th>Last Active</th>
              <th>Total Time</th>
              <th>Sessions</th>
              <th>Joined</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let allUsers = [];
    let adminDb, adminAuth;

    // Check authentication
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof firebase === 'undefined') {
        showError('Firebase not loaded');
        return;
      }

      adminAuth = window.firebaseAuth || firebase.auth();
      adminDb = window.firebaseDb || firebase.firestore();

      adminAuth.onAuthStateChanged((user) => {
        if (user) {
          // Check if user is admin (you can implement admin check here)
          checkAdminAccess(user);
        } else {
          showAuthRequired();
        }
      });
    });

    function showAuthRequired() {
      document.getElementById('authRequired').style.display = 'block';
      document.getElementById('dashboardContent').style.display = 'none';
    }

    function showDashboard() {
      document.getElementById('authRequired').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';
      loadDashboardData();
    }

    async function checkAdminAccess(user) {
      // For now, all authenticated users can access
      // In production, you'd check if user.email is in an admin list
      const adminEmails = ['alex@sheptech.co.uk', 'admin@example.com']; // Add your admin emails here

      // For development, allow all users
      showDashboard();

      // Uncomment for production:
      // if (adminEmails.includes(user.email)) {
      //   showDashboard();
      // } else {
      //   showError('You do not have admin access.');
      //   showAuthRequired();
      // }
    }

    async function loadDashboardData() {
      console.log('[DEBUG] ========== Starting Dashboard Load ==========');
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('loadingMessage').textContent = 'Loading users...';
      document.getElementById('usersTable').style.display = 'none';

      try {
        // Fetch all users
        console.log('[DEBUG] Fetching all users...');
        const usersSnapshot = await adminDb.collection('users').get();
        console.log(`[DEBUG] Found ${usersSnapshot.size} users`);
        allUsers = [];

        let totalSessions = 0;
        let totalSessionTime = 0;
        let activeUsersCount = 0;
        const now = new Date();
        const fiveMinutesAgo = new Date(now - 5 * 60 * 1000);

        let userIndex = 0;
        for (const doc of usersSnapshot.docs) {
          userIndex++;
          document.getElementById('loadingMessage').textContent = `Loading user ${userIndex}/${usersSnapshot.size}...`;
          console.log(`[DEBUG] Processing user ${userIndex}/${usersSnapshot.size}: ${doc.id}`);

          const userData = doc.data();

          // Get sessions for this user
          const sessionsSnapshot = await adminDb.collection('users').doc(doc.id)
            .collection('sessions').get();

          const sessionCount = sessionsSnapshot.size;
          totalSessions += sessionCount;

          // Check if user is currently active
          const lastActive = userData.lastActive?.toDate();
          const isActive = lastActive && lastActive > fiveMinutesAgo;
          if (isActive) activeUsersCount++;

          // Calculate total session time
          let userTotalTime = 0;
          const now = new Date();
          console.log(`[DEBUG] Processing ${sessionsSnapshot.size} sessions for user ${userData.email}`);

          sessionsSnapshot.forEach(sessionDoc => {
            const session = sessionDoc.data();
            let duration = session.duration || 0;

            console.log(`[DEBUG] Session ${sessionDoc.id}:`, {
              isActive: session.isActive,
              storedDuration: session.duration,
              startTime: session.startTime?.toDate(),
              hasStartTime: !!session.startTime
            });

            // For active sessions, calculate current duration from startTime
            if (session.isActive && session.startTime) {
              const startTime = session.startTime.toDate();
              const currentDuration = Math.floor((now - startTime) / 1000);
              duration = Math.max(duration, currentDuration);
              console.log(`[DEBUG] Active session - calculated duration: ${currentDuration}s (${Math.floor(currentDuration/60)}m)`);
            }

            if (duration > 0) {
              userTotalTime += duration;
              totalSessionTime += duration;
              console.log(`[DEBUG] Added ${duration}s to user total. New total: ${userTotalTime}s`);
            } else {
              console.log(`[DEBUG] Skipped session with 0 duration`);
            }
          });

          console.log(`[DEBUG] Final user total time: ${userTotalTime}s (${Math.floor(userTotalTime/60)}m)`);

          allUsers.push({
            id: doc.id,
            email: userData.email,
            displayName: userData.displayName || 'N/A',
            lastSignIn: userData.lastSignIn?.toDate(),
            lastActive: lastActive,
            totalTimeSpent: userTotalTime,
            sessionCount: sessionCount,
            createdAt: userData.createdAt?.toDate(),
            isActive: isActive
          });
        }

        // Update statistics
        console.log('[DEBUG] ========== SUMMARY ==========');
        console.log(`[DEBUG] Total users: ${allUsers.length}`);
        console.log(`[DEBUG] Active users: ${activeUsersCount}`);
        console.log(`[DEBUG] Total sessions: ${totalSessions}`);
        console.log(`[DEBUG] Total session time: ${totalSessionTime}s (${Math.floor(totalSessionTime/60)}m)`);
        console.log(`[DEBUG] Average session time: ${totalSessions > 0 ? Math.round(totalSessionTime / totalSessions / 60) : 0}m`);
        console.log('[DEBUG] ==================================');

        document.getElementById('totalUsers').textContent = allUsers.length;
        document.getElementById('activeUsers').textContent = activeUsersCount;
        document.getElementById('totalSessions').textContent = totalSessions;

        const avgTime = totalSessions > 0 ? Math.round(totalSessionTime / totalSessions / 60) : 0;
        document.getElementById('avgSessionTime').textContent = avgTime;

        // Sort users by last active (most recent first)
        allUsers.sort((a, b) => {
          if (!a.lastActive) return 1;
          if (!b.lastActive) return -1;
          return b.lastActive - a.lastActive;
        });

        // Display users
        displayUsers(allUsers);

        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('usersTable').style.display = 'table';

      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showError('Error loading data: ' + error.message);
      }
    }

    function displayUsers(users) {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';

      users.forEach(user => {
        const row = tbody.insertRow();

        // Status
        const statusCell = row.insertCell();
        const indicator = user.isActive ?
          '<span class="online-indicator"></span> Online' :
          '<span class="offline-indicator"></span> Offline';
        statusCell.innerHTML = indicator;

        // Email
        row.insertCell().textContent = user.email;

        // Name
        row.insertCell().textContent = user.displayName;

        // Last Sign In
        row.insertCell().textContent = formatDate(user.lastSignIn);

        // Last Active
        row.insertCell().textContent = formatRelativeTime(user.lastActive);

        // Total Time
        const timeCell = row.insertCell();
        timeCell.innerHTML = `<span class="time-badge">${formatDuration(user.totalTimeSpent)}</span>`;

        // Sessions
        const sessionsCell = row.insertCell();
        sessionsCell.innerHTML = `
          ${user.sessionCount}
          <div class="session-details">${user.totalTimeSpent > 0 ? formatDuration(user.totalTimeSpent / user.sessionCount) + ' avg' : ''}</div>
        `;

        // Joined
        row.insertCell().textContent = formatDate(user.createdAt);
      });
    }

    function filterUsers() {
      const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      let filtered = allUsers.filter(user => {
        // Search filter
        const matchesSearch = user.email.toLowerCase().includes(searchTerm) ||
                            user.displayName.toLowerCase().includes(searchTerm);

        // Status filter
        let matchesStatus = true;
        if (statusFilter === 'active') {
          matchesStatus = user.isActive;
        } else if (statusFilter === 'recent') {
          const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
          matchesStatus = user.lastActive && user.lastActive > oneDayAgo;
        }

        return matchesSearch && matchesStatus;
      });

      displayUsers(filtered);
    }

    function formatDate(date) {
      if (!date) return 'Never';
      return new Date(date).toLocaleString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatRelativeTime(date) {
      if (!date) return 'Never';

      const now = new Date();
      const diff = now - new Date(date);
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (seconds < 60) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return formatDate(date);
    }

    function formatDuration(seconds) {
      if (!seconds || seconds < 0) return '0m';

      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);

      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      }
      return `${minutes}m`;
    }

    function exportToCSV() {
      const headers = ['Email', 'Name', 'Last Sign In', 'Last Active', 'Total Time (seconds)', 'Sessions', 'Joined'];
      const rows = allUsers.map(user => [
        user.email,
        user.displayName,
        user.lastSignIn ? user.lastSignIn.toISOString() : '',
        user.lastActive ? user.lastActive.toISOString() : '',
        user.totalTimeSpent,
        user.sessionCount,
        user.createdAt ? user.createdAt.toISOString() : ''
      ]);

      const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `user-analytics-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>
