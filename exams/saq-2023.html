<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2023 SAQ Exam - MD3 SCP</title>

  <link rel="icon" type="image/png" href="../assets/ShepTech logo.png">
  <link rel="stylesheet" href="../css/main.css?v=20251109-1">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/dark-mode.js"></script>

  <style>
    /* Exam-specific styles */
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    .exam-container {
      display: flex;
      height: 100vh;
      background: var(--claude-cream);
    }

    /* Top header bar */
    .exam-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--claude-sidebar);
      border-bottom: 1px solid var(--claude-border);
      padding: 16px 40px 16px 140px;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .exam-title-section {
      display: flex;
      align-items: center;
      gap: 0;
      position: relative;
      flex: 1;
    }

    .exam-timer {
      font-family: Georgia, 'Times New Roman', serif;
      font-size: 20px;
      color: var(--claude-text);
      font-weight: 400;
      min-width: 100px;
      text-align: center;
    }

    .back-home-btn {
      position: absolute;
      left: -124px;
      padding: 8px 16px;
      background: var(--claude-card-bg);
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .back-home-btn:hover {
      background: var(--claude-light-accent);
      border-color: var(--claude-accent);
    }

    .exam-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--claude-text);
      margin: 0;
      padding-left: 0;
    }

    .exam-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .flag-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .flag-btn:hover {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.05);
    }

    .flag-btn.flagged {
      background: #ff6b6b;
      border-color: #ff6b6b;
      color: white;
    }

    /* Sidebar with question navigation */
    .exam-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 100px;
      height: 100vh;
      background: var(--claude-sidebar);
      border-right: 1px solid var(--claude-border);
      padding: 112px 16px 24px 16px;
      overflow-y: auto;
      z-index: 50;
    }

    .question-nav-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--claude-secondary);
      margin: 0 0 16px 0;
    }

    .question-nav-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .question-nav-btn {
      width: 48px;
      height: 48px;
      padding: 0;
      border: 2px solid var(--claude-border);
      background: var(--claude-card-bg);
      border-radius: 50%;
      font-size: 16px;
      font-weight: 600;
      color: var(--claude-text);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin: 0 auto;
    }

    .question-nav-btn:hover {
      border-color: #1e3a5f;
      background: rgba(30, 58, 95, 0.1);
    }

    .question-nav-btn.active {
      background: rgba(30, 58, 95, 0.1);
      color: var(--claude-text);
      border-color: #1e3a5f;
    }

    .question-nav-btn.answered {
      background: #1e3a5f;
      color: white;
      border-color: #1e3a5f;
    }

    .question-nav-btn.answered.active {
      background: #1e3a5f;
      color: white;
      border-color: #1e3a5f;
    }

    .question-nav-btn .flag-indicator {
      position: absolute;
      top: -6px;
      right: -6px;
      font-size: 18px;
      display: none;
    }

    .question-nav-btn.flagged .flag-indicator {
      display: block;
    }

    /* Main content area */
    .exam-content {
      margin-top: 72px;
      margin-left: 100px;
      width: calc(100% - 100px);
      min-width: calc(100% - 100px);
      max-width: calc(100% - 100px);
      height: calc(100vh - 72px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: fixed;
      right: 0;
    }

    .question-container {
      flex: 1;
      overflow-y: auto;
      padding: 40px;
      padding-bottom: 0;
      width: 100%;
      box-sizing: border-box;
    }

    .question-content-wrapper {
      width: 100% !important;
      max-width: 100% !important;
      min-width: 100% !important;
      display: flex !important;
      flex-direction: column !important;
      box-sizing: border-box;
    }

    .question-content-wrapper > * {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
    }

    .question-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      width: 100%;
    }

    .question-number {
      font-size: 20px;
      font-weight: 400;
      font-family: Georgia, 'Times New Roman', serif;
      color: var(--claude-text);
    }

    .question-header .flag-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .question-header .flag-btn:hover {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.05);
    }

    .question-header .flag-btn.flagged {
      background: #ff6b6b;
      border-color: #ff6b6b;
      color: white;
    }

    .question-text {
      font-size: 16px;
      line-height: 1.7;
      color: var(--claude-text);
      margin-bottom: 16px;
      padding: 24px;
      background: var(--claude-card-bg);
      border: 1px solid var(--claude-border);
      border-radius: 12px;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
      display: block;
    }

    .sub-questions {
      margin-left: 20px;
      margin-top: 16px;
      width: 100%;
    }

    .sub-question {
      margin-bottom: 24px;
      width: 100%;
    }

    .sub-question-label {
      font-weight: 600;
      color: var(--claude-text);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .answer-area {
      margin-top: 0;
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
      display: block;
    }

    .answer-input {
      width: 100% !important;
      max-width: 100% !important;
      min-height: 400px;
      padding: 16px;
      border: 1px solid var(--claude-border);
      border-radius: 12px;
      font-family: var(--font-sans);
      font-size: 15px;
      line-height: 1.7;
      color: var(--claude-text);
      background: var(--claude-card-bg);
      resize: vertical;
      transition: all 0.2s ease;
      box-sizing: border-box;
      display: block;
    }

    .answer-input:focus {
      outline: none;
      border-color: var(--claude-accent);
      box-shadow: 0 0 0 3px rgba(204, 120, 92, 0.1);
    }

    .question-actions {
      display: flex;
      justify-content: space-between;
      padding: 24px 40px;
      border-top: 1px solid var(--claude-border);
      background: var(--claude-sidebar);
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .nav-buttons-left {
      display: flex;
      gap: 12px;
    }

    .nav-btn {
      padding: 12px 24px;
      background: var(--claude-card-bg);
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .nav-btn:hover:not(:disabled) {
      background: var(--claude-light-accent);
      border-color: var(--claude-accent);
    }

    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .nav-btn.primary {
      background: #1e3a5f;
      color: white;
      border-color: #1e3a5f;
    }

    .nav-btn.primary:hover:not(:disabled) {
      background: #0A2540;
    }

    .finish-btn {
      padding: 12px 24px;
      background: #4CAF50;
      border: 1.5px solid #4CAF50;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .finish-btn:hover {
      background: #45a049;
      border-color: #45a049;
    }
    /* Progress Check Modal */
    .progress-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .progress-modal-content {
      background: var(--claude-card-bg);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .progress-modal h2 {
      margin: 0 0 16px 0;
      font-size: 24px;
      color: var(--claude-text);
      font-family: Georgia, 'Times New Roman', serif;
    }

    .progress-modal p {
      margin: 0 0 24px 0;
      font-size: 16px;
      color: var(--claude-secondary);
      line-height: 1.5;
    }

    .progress-modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .progress-modal-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1.5px solid;
    }

    .progress-modal-btn.reset {
      background: white;
      border-color: var(--claude-border);
      color: var(--claude-text);
    }

    .progress-modal-btn.reset:hover {
      background: var(--claude-light-accent);
      border-color: var(--claude-accent);
    }

    .progress-modal-btn.continue {
      background: #1e3a5f;
      border-color: #1e3a5f;
      color: white;
    }

    .progress-modal-btn.continue:hover {
      background: #0A2540;
      border-color: #0A2540;
    }
  </style>
</head>
<body>
  <!-- Progress Check Modal -->
  <div class="progress-modal" id="progressModal">
    <div class="progress-modal-content">
      <h2>Continue Exam?</h2>
      <p>Would you like to continue where you left off, or reset and start a new attempt?</p>
      <div class="progress-modal-buttons">
        <button class="progress-modal-btn reset" id="resetExamBtn">Reset Exam</button>
        <button class="progress-modal-btn continue" id="continueExamBtn">Continue Current Attempt</button>
      </div>
    </div>
  </div>

  <div class="exam-container">
    <!-- Top header bar -->
    <div class="exam-header">
      <div class="exam-title-section">
        <button class="back-home-btn" id="backBtn">
          <span>‚Üê</span> Back
        </button>
        <h1 class="exam-title">2023 SAQ Exam</h1>
      </div>

      <div class="exam-actions">
        <div class="exam-timer" id="examTimer">00:00:00</div>
      </div>
    </div>

    <!-- Sidebar with question navigation -->
    <div class="exam-sidebar">
      <div class="question-nav-list" id="questionNavList">
        <!-- Question buttons will be generated by JavaScript -->
      </div>
    </div>

    <!-- Main content -->
    <div class="exam-content">
      <div class="question-container" id="questionContainer">
        <!-- Question content will be loaded here -->
      </div>

      <div class="question-actions">
        <div class="nav-buttons-left">
          <button class="nav-btn" id="prevBtn">‚Üê Previous</button>
          <button class="nav-btn primary" id="nextBtn">Next ‚Üí</button>
        </div>
        <button class="finish-btn" id="finishBtn">Finish</button>
      </div>
    </div>
  </div>

  <script>
    // Use Firebase instances from firebase-config.js
    let examAuth = null;
    let examDb = null;
    let examUser = null;

    // Initialize Firebase by using the already-initialized instances
    function initFirebase() {
      try {
        // Wait for firebase-config.js to load
        if (window.firebaseAuth && window.firebaseDb) {
          examAuth = window.firebaseAuth;
          examDb = window.firebaseDb;

          // Get current user
          examUser = examAuth.currentUser;

          // Listen for auth state changes
          examAuth.onAuthStateChanged((user) => {
            examUser = user;
            if (user) {
              console.log('[Exam] User signed in:', user.email);
              // Load user's exam progress from Firestore
              loadProgressFromFirestore();
            } else {
              console.log('[Exam] User signed out');
              // Fall back to localStorage
              loadProgress();
            }
          });

          console.log('[Exam] Firebase connected');
        } else {
          console.log('[Exam] Firebase not available, using localStorage only');
        }
      } catch (error) {
        console.error('[Exam] Firebase initialization error:', error);
      }
    }

    // Exam data - Real questions from 2023 MEDI6003 exam
    const examData = {
      title: '2023 SAQ Exam',
      totalQuestions: 38,
      questions: [
        {
          id: 1,
          text: "My Health Record",
          subQuestions: ["a. 2 acts of legislation", "b. 5 benefits of shared electronic records", "c. 5 disadvantages of shared electronic records"],
          answer: '',
          flagged: false
        },
        {
          id: 2,
          text: "Graph comparing prevalence of ESKD in Australia between Indigenous and non-Indigenous and based on remoteness in 2017",
          subQuestions: ["a. What is the epidemiological measure that is used in this graph?", "b. What are 3 trends?", "c. What are 2 underlying reasons for the distribution of Indigenous ESKD in the remote region?"],
          answer: '',
          flagged: false
        },
        {
          id: 3,
          text: "Graph comparing BMI of individuals aged 18 and over from 1995 to 2017/18",
          subQuestions: ["a. What are 2 changes to the modal BMI between the years?", "b. What changed in the normal weight group", "c. What changed in the obese weight group", "d. Give 2 population level personal reasons for these changes"],
          answer: '',
          flagged: false
        },
        {
          id: 4,
          text: "Graph showing highest expenditure drugs.",
          subQuestions: ["a. What CV risk factor does the highest expenditure drug (rosuvastatin) address?", "b. What are 4 preventable lifestyle factors that can reduce CVD risk and also contribute to a high disease burden?"],
          answer: '',
          flagged: false
        },
        {
          id: 5,
          text: "Pertussis question",
          subQuestions: ["a. What changed to pertussis vaccination schedule in 2015?", "b. What clinical feature must be present to consider pertussis?", "c. What is another clinical feature that makes pertussis definitive?", "d. What are 2 other changes that occurred to reduce severe pertussis?", "e. What is an absolute contraindication to the acellular pertussis vaccine"],
          answer: '',
          flagged: false
        },
        {
          id: 6,
          text: "What are five things legally required in GP notes (National Health Practitioner Law)?",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 7,
          text: "Shared decision making",
          subQuestions: ["a. What are 2 features of shared decision-making?", "b. What are 5 benefits of shared-decision making?"],
          answer: '',
          flagged: false
        },
        {
          id: 8,
          text: "List 4 manifestations of growing up exposed to domestic violence that you may see in an adolescent/young adult?",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 9,
          text: "Scenario where mother brings her young daughter into GP - note rashes & other injuries. Mother says the child has been abused by father. Need to explain to medical student colleague why doctor-patient confidentiality can be breached in this situation (2 marks)",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 10,
          text: "Scenario where on-call consultant wants you to take a clinical image of a face laceration.",
          subQuestions: ["a. What are 3 things you need to consider (general principles) before taking a clinical image?", "b. What 2 things would you do once the image has been taken?"],
          answer: '',
          flagged: false
        },
        {
          id: 11,
          text: "35 year old woman comes for a checkup at the GP after surgery. Surgery went well and there are no problems. She hasn't seen the GP in 3 years.",
          subQuestions: ["a. What are 2 opportunistic preventative things the GP could do? (2 marks)", "b. Explain how the GP could explain the benefits of each item (2 marks)"],
          answer: '',
          flagged: false
        },
        {
          id: 12,
          text: "20 year old woman presents to the GP seeking a prescription of COCP. She has had unprotected sex for the past 2 weeks. What are 5 things to screen for before prescribing the pill.",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 13,
          text: "25-year-old has type I diabetes diagnosed 10 years ago. What are 5 reasons why they might find it difficult to attend their multidisciplinary care appointments/treatments?",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 14,
          text: "4 characteristics of body dysmorphia",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 15,
          text: "Hypertensive urgency (aortic dissection) >190 systolic",
          subQuestions: ["a. 3 pharmacological treatments to start"],
          answer: '',
          flagged: false
        },
        {
          id: 16,
          text: "G2P2 woman presents at 34 weeks gestation with reduced foetal movements, heavy bleeding and on examination had tender rigid abdomen (uterus?) pain in epigastric region, tense and rigid abdomen",
          subQuestions: ["a. Diagnosis", "b. 5 steps in initial management"],
          answer: '',
          flagged: false
        },
        {
          id: 17,
          text: "Patient comes in feeling tired and complaining of weight gain. You suspect hypothyroidism.",
          subQuestions: ["a. What are 4 history questions for hypothyroidism?", "b. 4 exam findings"],
          answer: '',
          flagged: false
        },
        {
          id: 18,
          text: "30-year-old woman presents 2 weeks post birth with rigors, fever and chills, and her left breast is red and hot to touch.",
          subQuestions: ["a. What is the diagnosis", "b. Outline her management (6 things)"],
          answer: '',
          flagged: false
        },
        {
          id: 19,
          text: "85yo man with short term memory loss, disoriented, MMSE 23/30, no loss of attention",
          subQuestions: ["a. 3 investigations", "b. 2 differentials"],
          answer: '',
          flagged: false
        },
        {
          id: 20,
          text: "Schizophrenia",
          subQuestions: ["a. 4 negative symptoms of schizophrenia (2 marks)", "b. How to manage (4 marks)"],
          answer: '',
          flagged: false
        },
        {
          id: 21,
          text: "A child has many findings of bacterial meningitis and CSF microscopy shows gram negative diplococci.",
          subQuestions: ["a. Give 3 causative organisms", "b. What are 2 empiric antibiotics", "c. 5 features of respiratory distress in the newborn"],
          answer: '',
          flagged: false
        },
        {
          id: 22,
          text: "30 year old woman was taking psychotropic drugs for a mental disorder. 1 year later, she visits the psychiatrist and complains of 6 months of amenorrhea and 2 months of galactorrhea.",
          subQuestions: ["a. 4 investigations", "b. Diagnosis", "c. Management (4 marks)"],
          answer: '',
          flagged: false
        },
        {
          id: 23,
          text: "30-year-old woman with curd-like vaginal discharge with pruritus and vulval pain.",
          subQuestions: ["a. Diagnosis (1 mark)", "b. Management (3 marks)"],
          answer: '',
          flagged: false
        },
        {
          id: 24,
          text: "Women has recently been diagnosed with osteopaenia",
          subQuestions: ["a. 4 risk factors", "b. 4 things GP should discuss with the patient"],
          answer: '',
          flagged: false
        },
        {
          id: 25,
          text: "What are 6 drugs for unstable angina",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 26,
          text: "What are 6 side effects of olanzapine",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 27,
          text: "Woman has jaundice and 6 day malaise. Bilirubin is raised, AST & ALT just above normal range, ALP more than 2x normal range. No GGT given. Urinalysis shows negative urobilinogen",
          subQuestions: ["a. What is the diagnosis?", "b. Explain your reasoning (2 marks)"],
          answer: '',
          flagged: false
        },
        {
          id: 28,
          text: "4 discussion points on lithium toxicity at a GP to ensure they stay well",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 29,
          text: "Febrile convulsion 1 day hx of fever, 15 min generalised tonic clonic, still seizing. 4 things in management",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 30,
          text: "A 53-year-old female presents with pleuritic chest pain, SOB and tachycardia (HR>100). Her creatine is has elevated (160mmol/L) and she has an eGFR of <35, but otherwise normal vitals. Chest Xray is normal. She has several medical conditions (SLE, hypertension, CKD) and is on several medications including OCP, thiazide, diflofenac and ramipril",
          subQuestions: ["a. What criteria can be used to gauge if she has pulmonary embolism?", "b. What probability is she of a PE?", "c. What investigation would you do next?", "d. What 2 imaging studies can you do?"],
          answer: '',
          flagged: false
        },
        {
          id: 31,
          text: "What are 4 risk factors for development of gallstones",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 32,
          text: "Man has not passed flatus in 2 days. Xray & CT provided (showing small bowel obstruction - valvulae conniventes & centrally located).",
          subQuestions: ["a. What are 3 features that can be seen on imaging", "b. What is your diagnosis"],
          answer: '',
          flagged: false
        },
        {
          id: 33,
          text: "Patient has just given birth and after the placenta is delivered she is bleeding profusely. What are 4 reasons this may be happening?",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 34,
          text: "6 differentials for post menopausal bleeding not on HRT (last menstrual period 5 years ago)",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 35,
          text: "Patient has fractured his femur. What are 6 possible complications of long bone fractures?",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 36,
          text: "Post splenectomy",
          subQuestions: ["a. What is the key risk? (long term risk)", "b. What are three key considerations of management (outside peri-operative care)"],
          answer: '',
          flagged: false
        },
        {
          id: 37,
          text: "Four advantages of laparoscopic surgery vs open surgery for appendectomy",
          subQuestions: [],
          answer: '',
          flagged: false
        },
        {
          id: 38,
          text: "Man with hypertension has started medications for it but is still hypertensive when coming back to the GP six months later. What are three reasons this may be?",
          subQuestions: [],
          answer: '',
          flagged: false
        }
      ]
    };

    // State
    let currentQuestionIndex = 0;
    let timerStartTime = null;
    let timerInterval = null;

    // Timer functions
    function startTimer() {
      timerStartTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
      const elapsed = Date.now() - timerStartTime;
      const hours = Math.floor(elapsed / 3600000);
      const minutes = Math.floor((elapsed % 3600000) / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);

      const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      document.getElementById('examTimer').textContent = timeString;
    }

    // Initialize
    function initExam() {
      generateQuestionNav();
      loadQuestion(0);

      // Start the timer
      startTimer();

      // Initialize Firebase first
      initFirebase();

      // If no user is signed in after a short delay, load from localStorage
      setTimeout(() => {
        if (!examUser) {
          loadProgress();
        }
      }, 1000);
    }

    // Generate question navigation buttons
    function generateQuestionNav() {
      const navList = document.getElementById('questionNavList');
      navList.innerHTML = '';

      examData.questions.forEach((q, index) => {
        const btn = document.createElement('button');
        btn.className = 'question-nav-btn';

        const questionLabel = document.createElement('span');
        questionLabel.textContent = `${index + 1}`;

        const flagIndicator = document.createElement('span');
        flagIndicator.className = 'flag-indicator';
        flagIndicator.textContent = 'üö©';

        btn.appendChild(questionLabel);
        btn.appendChild(flagIndicator);

        if (q.answer && q.answer.trim()) btn.classList.add('answered');
        if (q.flagged) btn.classList.add('flagged');
        if (index === currentQuestionIndex) btn.classList.add('active');

        btn.addEventListener('click', () => loadQuestion(index));
        navList.appendChild(btn);
      });
    }

    // Load question
    function loadQuestion(index) {
      if (currentQuestionIndex !== index) {
        saveCurrentAnswer();
      }

      currentQuestionIndex = index;
      const question = examData.questions[index];

      // Build question HTML
      let html = `
        <div class="question-content-wrapper">
          <div class="question-header">
            <div class="question-number">Question ${index + 1}</div>
            <button class="flag-btn" id="flagBtn">
              <span id="flagBtnText">${question.flagged ? 'Flagged' : 'Flag Question'}</span>
            </button>
          </div>
          <div class="question-text">${question.text}`;

      if (question.subQuestions && question.subQuestions.length > 0) {
        html += '<div class="sub-questions">';
        question.subQuestions.forEach(sq => {
          html += `<div class="sub-question">${sq}</div>`;
        });
        html += '</div>';
      }

      html += `</div>
          <div class="answer-area">
            <textarea id="answerInput" class="answer-input" placeholder="Type your answer here...">${question.answer || ''}</textarea>
          </div>
        </div>`;

      document.getElementById('questionContainer').innerHTML = html;

      // Update flag button
      const flagBtn = document.getElementById('flagBtn');
      if (flagBtn) {
        if (question.flagged) {
          flagBtn.classList.add('flagged');
        } else {
          flagBtn.classList.remove('flagged');
        }

        // Add event listener to flag button
        flagBtn.addEventListener('click', () => {
          examData.questions[currentQuestionIndex].flagged = !examData.questions[currentQuestionIndex].flagged;
          loadQuestion(currentQuestionIndex);
        });
      }

      // Update navigation buttons
      document.getElementById('prevBtn').disabled = index === 0;
      document.getElementById('nextBtn').disabled = index === examData.totalQuestions - 1;

      // Auto-save on input
      document.getElementById('answerInput').addEventListener('input', () => {
        saveCurrentAnswer();
        generateQuestionNav();
      });

      generateQuestionNav();
      saveProgress();
    }

    // Save current answer
    function saveCurrentAnswer() {
      const answerInput = document.getElementById('answerInput');
      if (answerInput) {
        examData.questions[currentQuestionIndex].answer = answerInput.value;
        saveProgress();
      }
    }

    // Save progress to Firestore (if authenticated) or localStorage
    async function saveProgress() {
      const progressData = {
        currentQuestionIndex,
        questions: examData.questions.map(q => ({
          id: q.id,
          answer: q.answer,
          flagged: q.flagged
        })),
        lastUpdated: new Date().toISOString()
      };

      // Save to localStorage as fallback
      localStorage.setItem('saq-2023-progress', JSON.stringify(progressData));

      // Save to Firestore if authenticated
      if (examUser && examDb) {
        try {
          await examDb.collection('users')
            .doc(examUser.uid)
            .collection('exams')
            .doc('saq-2023')
            .set(progressData, { merge: true });
          console.log('[Exam] Progress saved to Firestore');
        } catch (error) {
          console.error('[Exam] Error saving to Firestore:', error);
        }
      }
    }

    // Load progress from Firestore
    async function loadProgressFromFirestore() {
      if (!examUser || !examDb) return;

      try {
        const doc = await examDb.collection('users')
          .doc(examUser.uid)
          .collection('exams')
          .doc('saq-2023')
          .get();

        if (doc.exists) {
          const progress = doc.data();
          currentQuestionIndex = progress.currentQuestionIndex || 0;

          // Restore answers and flags
          if (progress.questions) {
            progress.questions.forEach(savedQ => {
              const question = examData.questions.find(q => q.id === savedQ.id);
              if (question) {
                question.answer = savedQ.answer || '';
                question.flagged = savedQ.flagged || false;
              }
            });
          }

          console.log('[Exam] Progress loaded from Firestore');
          loadQuestion(currentQuestionIndex);
        } else {
          // No Firestore data, check localStorage for migration
          loadProgress();
        }
      } catch (error) {
        console.error('[Exam] Error loading from Firestore:', error);
        loadProgress();
      }
    }

    // Load progress from localStorage
    function loadProgress() {
      const saved = localStorage.getItem('saq-2023-progress');
      if (saved) {
        const progress = JSON.parse(saved);
        currentQuestionIndex = progress.currentQuestionIndex || 0;

        // Restore answers and flags
        if (progress.questions) {
          progress.questions.forEach(savedQ => {
            const question = examData.questions.find(q => q.id === savedQ.id);
            if (question) {
              question.answer = savedQ.answer || '';
              question.flagged = savedQ.flagged || false;
            }
          });
        }

        loadQuestion(currentQuestionIndex);
      }
    }

    // Function to return to SAQ Exams modal
    function returnToExams() {
      saveCurrentAnswer();
      window.location.href = '../index.html#past-exams';
    }

    // Event listeners
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentQuestionIndex > 0) {
        loadQuestion(currentQuestionIndex - 1);
      }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentQuestionIndex < examData.totalQuestions - 1) {
        loadQuestion(currentQuestionIndex + 1);
      }
    });

    document.getElementById('finishBtn').addEventListener('click', () => {
      returnToExams();
    });

    document.getElementById('backBtn').addEventListener('click', () => {
      returnToExams();
    });

    // Auto-save every 30 seconds
    setInterval(saveCurrentAnswer, 30000);

    // Check for existing progress and show modal if needed
    function checkExistingProgress() {
      const saved = localStorage.getItem('saq-2023-progress');
      if (saved) {
        const progress = JSON.parse(saved);
        // Check if there's any actual progress (answered questions)
        const hasProgress = progress.questions && progress.questions.some(q => q.answer && q.answer.trim());

        if (hasProgress) {
          // Show modal
          const modal = document.getElementById('progressModal');
          modal.style.display = 'flex';

          // Handle continue button
          document.getElementById('continueExamBtn').addEventListener('click', () => {
            modal.style.display = 'none';
            initExam();
          });

          // Handle reset button
          document.getElementById('resetExamBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to reset this exam? All progress will be permanently deleted.')) {
              return;
            }

            // Clear Firestore first if available
            if (examUser && examDb) {
              try {
                await examDb.collection('users')
                  .doc(examUser.uid)
                  .collection('exams')
                  .doc('saq-2023')
                  .delete();
                console.log('[Exam] Progress deleted from Firestore');
              } catch (error) {
                console.error('[Exam] Error deleting from Firestore:', error);
              }
            }

            // Clear localStorage
            localStorage.removeItem('saq-2023-progress');
            localStorage.removeItem('saq-2023-completed');

            // Reset exam data in memory
            examData.questions.forEach(q => {
              q.answer = '';
              q.flagged = false;
            });

            currentQuestionIndex = 0;
            elapsedSeconds = 0;

            modal.style.display = 'none';

            // Reinitialize exam with fresh state
            generateQuestionNav();
            loadQuestion(0);
            startTimer();
          });

          return; // Don't auto-initialize
        }
      }

      // No progress found, initialize normally
      initExam();
    }

    // Initialize
    checkExistingProgress();
  </script>
</body>
</html>
