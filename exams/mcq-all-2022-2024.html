<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All MCQs from 2022, 2023 & 2024 with Answers! - MD3 SCP</title>

  <link rel="icon" type="image/png" href="../assets/ShepTech logo.png">
  <link rel="stylesheet" href="../css/main.css?v=20251109-1">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/dark-mode.js"></script>

  <style>
    /* Donation Splash Screen */
    .donation-splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease-in;
    }

    .donation-splash.hide {
      animation: fadeOut 0.5s ease-out forwards;
    }

    .donation-text {
      font-size: 48px;
      font-weight: 700;
      color: #fff;
      text-align: center;
      animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      text-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
      letter-spacing: 2px;
    }

    .donation-text span {
      display: inline-block;
      animation: rainbow 3s linear infinite;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7, #ff6b6b);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    @keyframes bounceIn {
      0% {
        transform: scale(0.3);
        opacity: 0;
      }
      50% {
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Exam-specific styles */
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    .exam-container {
      display: flex;
      height: 100vh;
      background: var(--claude-cream);
    }

    /* Top header bar */
    .exam-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--claude-sidebar);
      border-bottom: 1px solid var(--claude-border);
      padding: 16px 40px 16px 140px;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .exam-title-section {
      display: flex;
      align-items: center;
      gap: 0;
      position: relative;
      flex: 1;
    }

    .exam-timer {
      font-family: Georgia, 'Times New Roman', serif;
      font-size: 20px;
      color: var(--claude-text);
      font-weight: 400;
      min-width: 100px;
      text-align: center;
    }

    .back-home-btn {
      position: absolute;
      left: -124px;
      padding: 8px 16px;
      background: var(--claude-card-bg);
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .back-home-btn:hover {
      background: var(--claude-light-accent);
      border-color: var(--claude-accent);
    }

    .exam-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--claude-text);
      margin: 0;
      padding-left: 0;
    }

    .exam-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .flag-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .flag-btn:hover {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.05);
    }

    .flag-btn.flagged {
      background: #ff6b6b;
      border-color: #ff6b6b;
      color: white;
    }

    /* Sidebar with question navigation */
    .exam-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 100px;
      height: 100vh;
      background: var(--claude-sidebar);
      border-right: 1px solid var(--claude-border);
      padding: 112px 16px 24px 16px;
      overflow-y: auto;
      z-index: 50;
    }

    .question-nav-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--claude-secondary);
      margin: 0 0 16px 0;
    }

    .question-nav-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .question-nav-btn {
      width: 48px;
      height: 48px;
      padding: 0;
      border: 2px solid var(--claude-border);
      background: var(--claude-card-bg);
      border-radius: 50%;
      font-size: 16px;
      font-weight: 600;
      color: var(--claude-text);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin: 0 auto;
    }

    .question-nav-btn:hover {
      border-color: #1e3a5f;
      background: rgba(30, 58, 95, 0.1);
    }

    .question-nav-btn.active {
      background: rgba(30, 58, 95, 0.1);
      color: var(--claude-text);
      border-color: #1e3a5f;
    }

    .question-nav-btn.answered {
      background: #1e3a5f;
      color: white;
      border-color: #1e3a5f;
    }

    .question-nav-btn.answered.active {
      background: #1e3a5f;
      color: white;
      border-color: #1e3a5f;
    }

    .question-nav-btn .flag-indicator {
      position: absolute;
      top: -6px;
      right: -6px;
      font-size: 18px;
      display: none;
    }

    .question-nav-btn.flagged .flag-indicator {
      display: block;
    }

    /* Main content area */
    .exam-content {
      margin-top: 72px;
      margin-left: 100px;
      width: calc(100% - 100px);
      min-width: calc(100% - 100px);
      max-width: calc(100% - 100px);
      height: calc(100vh - 72px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: fixed;
      right: 0;
    }

    .question-container {
      flex: 1;
      overflow-y: auto;
      padding: 40px;
      padding-bottom: 0;
      width: 100%;
      box-sizing: border-box;
    }

    .question-content-wrapper {
      width: 100% !important;
      max-width: 100% !important;
      min-width: 100% !important;
      display: flex !important;
      flex-direction: column !important;
      box-sizing: border-box;
    }

    .question-content-wrapper > * {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
    }

    .question-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      width: 100%;
    }

    .question-number {
      font-size: 20px;
      font-weight: 400;
      font-family: Georgia, 'Times New Roman', serif;
      color: var(--claude-text);
    }

    .question-header .flag-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .question-header .flag-btn:hover {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.05);
    }

    .question-header .flag-btn.flagged {
      background: #ff6b6b;
      border-color: #ff6b6b;
      color: white;
    }

    .question-text {
      font-size: 16px;
      line-height: 1.7;
      color: var(--claude-text);
      margin-bottom: 24px;
      padding: 24px;
      background: var(--claude-card-bg);
      border: 1px solid var(--claude-border);
      border-radius: 12px;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
      display: block;
    }

    /* MCQ Options Styling */
    .mcq-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
      width: 100%;
    }

    .mcq-option {
      padding: 16px 20px;
      padding-right: 110px;
      border: 2px solid var(--claude-border);
      border-radius: 12px;
      background: var(--claude-card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
      color: var(--claude-text);
      box-sizing: border-box;
      position: relative;
    }

    .mcq-option:hover {
      border-color: #1e3a5f;
      background: rgba(30, 58, 95, 0.1);
    }

    .mcq-option.selected {
      border-color: #1e3a5f;
      background: rgba(30, 58, 95, 0.1);
      color: var(--claude-text);
    }

    .mcq-option-label {
      font-weight: 600;
      min-width: 24px;
      font-family: var(--font-sans);
    }

    .mcq-option-check {
      position: absolute;
      right: 20px;
      color: #1e3a5f;
      font-size: 20px;
      font-weight: bold;
      display: none !important;
    }

    .your-answer-label {
      position: absolute;
      right: 20px;
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font-serif);
      display: none;
      align-items: center;
      gap: 4px;
    }

    .mcq-option .your-answer-label.show {
      display: flex;
    }

    .your-answer-label.correct {
      color: #4CAF50;
    }

    .your-answer-label.incorrect {
      color: #f44336;
    }

    .mcq-option.correct-highlight {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.2);
      font-weight: 600;
    }

    .mcq-option.incorrect-highlight {
      border-color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }

    /* Show Answer Section */
    .show-answer-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--claude-border);
    }

    .show-answer-btn {
      padding: 10px 20px;
      background: var(--claude-card-bg);
      border: 2px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .show-answer-btn:hover {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }

    .correct-answer-display {
      margin-top: 16px;
      padding: 16px;
      background: rgba(76, 175, 80, 0.1);
      border: 2px solid #4CAF50;
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 15px;
    }

    .correct-answer-display strong {
      color: #4CAF50;
    }

    .question-actions {
      display: flex;
      justify-content: space-between;
      padding: 24px 40px;
      border-top: 1px solid var(--claude-border);
      background: var(--claude-sidebar);
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .nav-buttons-left {
      display: flex;
      gap: 12px;
    }

    .nav-btn {
      padding: 12px 24px;
      background: var(--claude-card-bg);
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .nav-btn:hover:not(:disabled) {
      background: var(--claude-light-accent);
      border-color: var(--claude-accent);
    }

    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .nav-btn.primary {
      background: #1e3a5f;
      color: white;
      border-color: #1e3a5f;
    }

    .nav-btn.primary:hover:not(:disabled) {
      background: #0A2540;
    }

    .finish-btn {
      padding: 12px 24px;
      background: #1e3a5f;
      border: 1.5px solid #1e3a5f;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .finish-btn:hover {
      background: #0A2540;
      border-color: #0A2540;
    }

    /* Results Modal */
    .results-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .results-modal.show {
      display: flex;
    }

    .results-content {
      background: var(--claude-card-bg);
      border-radius: 16px;
      padding: 40px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .results-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .results-header h2 {
      color: var(--claude-text);
      font-size: 32px;
      margin: 0 0 16px 0;
    }

    .results-score {
      font-size: 48px;
      font-weight: bold;
      color: #4CAF50;
      margin: 16px 0;
    }

    .results-stats {
      display: flex;
      justify-content: space-around;
      margin: 24px 0;
      padding: 20px;
      background: var(--claude-bg);
      border-radius: 12px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: var(--claude-text);
    }

    .stat-label {
      font-size: 14px;
      color: var(--claude-muted);
      margin-top: 4px;
    }

    .results-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 32px;
    }

    .results-btn {
      padding: 14px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid var(--claude-border);
      background: var(--claude-card-bg);
      color: var(--claude-text);
    }

    .results-btn.primary {
      background: #1e3a5f;
      border-color: #1e3a5f;
      color: white;
    }

    .results-btn.primary:hover {
      background: #0A2540;
      border-color: #0A2540;
    }

    .results-btn:hover {
      border-color: #1e3a5f;
      background: rgba(30, 58, 95, 0.1);
    }

    /* Review Mode */
    .review-mode-banner {
      display: none;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--claude-border);
      border-radius: 0;
      padding: 8px 20px;
      margin-bottom: 16px;
      text-align: left;
      color: var(--claude-secondary);
      font-weight: 500;
      font-size: 13px;
    }

    .review-mode-banner.show {
      display: block;
    }
    /* Progress Check Modal */
    .progress-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      justify-content: center;
      align-items: center;
    }

    .progress-modal-content {
      background: var(--claude-card-bg);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .progress-modal h2 {
      margin: 0 0 16px 0;
      font-size: 24px;
      color: var(--claude-text);
      font-family: Georgia, 'Times New Roman', serif;
    }

    .progress-modal p {
      margin: 0 0 24px 0;
      font-size: 16px;
      color: var(--claude-secondary);
      line-height: 1.5;
    }

    .progress-modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .progress-modal-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1.5px solid;
    }

    .progress-modal-btn.reset {
      background: white;
      border-color: var(--claude-border);
      color: var(--claude-text);
    }

    .progress-modal-btn.reset:hover {
      background: var(--claude-light-accent);
      border-color: var(--claude-accent);
    }

    .progress-modal-btn.continue {
      background: #1e3a5f;
      border-color: #1e3a5f;
      color: white;
    }

    .progress-modal-btn.continue:hover {
      background: #0A2540;
      border-color: #0A2540;
    }
  </style>
  <script src="../js/user-analytics.js"></script>
  <script src="../js/exam-page-tracker.js"></script>
</head>
<body>
  <!-- Donation Splash Screen -->
  <div class="donation-splash" id="donationSplash">
    <div class="donation-text">
      <span>Donated by Jeztech</span>
    </div>
  </div>

  <!-- Progress Check Modal -->
  <div class="progress-modal" id="progressModal">
    <div class="progress-modal-content">
      <h2>Continue Exam?</h2>
      <p>Would you like to continue where you left off, or reset and start a new attempt?</p>
      <div class="progress-modal-buttons">
        <button class="progress-modal-btn reset" id="resetExamModalBtn">Reset Exam</button>
        <button class="progress-modal-btn continue" id="continueExamBtn">Continue Current Attempt</button>
      </div>
    </div>
  </div>

  <div class="exam-container">
    <!-- Top header bar -->
    <div class="exam-header">
      <div class="exam-title-section">
        <button class="back-home-btn" id="backBtn">
          <span>‚Üê</span> Back
        </button>
        <h1 class="exam-title">All MCQs from 2022, 2023 & 2024 with Answers!</h1>
      </div>

      <div class="exam-actions">
        <div class="exam-timer" id="examTimer">00:00:00</div>
      </div>
    </div>

    <!-- Sidebar with question navigation -->
    <div class="exam-sidebar">
      <div class="question-nav-list" id="questionNavList">
        <!-- Question buttons will be generated by JavaScript -->
      </div>
    </div>

    <!-- Main content -->
    <div class="exam-content">
      <div class="review-mode-banner" id="reviewModeBanner">
        Review Mode
      </div>
      <div class="question-container" id="questionContainer">
        <!-- Question content will be loaded here -->
      </div>

      <div class="question-actions">
        <div class="nav-buttons-left">
          <button class="nav-btn" id="prevBtn">‚Üê Previous</button>
          <button class="nav-btn primary" id="nextBtn">Next ‚Üí</button>
        </div>
        <button class="finish-btn" id="finishBtn">Submit & Review Answers</button>
        <button class="finish-btn" id="finishReviewBtn" style="display: none;">Finish Review</button>
      </div>
    </div>
  </div>

  <!-- Results Modal -->
  <div class="results-modal" id="resultsModal">
    <div class="results-content">
      <div class="results-header">
        <h2>Exam Complete!</h2>
        <div class="results-score" id="resultsScore">0%</div>
      </div>

      <div class="results-stats">
        <div class="stat-item">
          <div class="stat-value" id="correctCount">0</div>
          <div class="stat-label">Correct</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="incorrectCount">0</div>
          <div class="stat-label">Incorrect</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="unansweredCount">0</div>
          <div class="stat-label">Unanswered</div>
        </div>
      </div>

      <div class="results-actions">
        <button class="results-btn primary" id="reviewAnswersBtn">Review Answers</button>
        <button class="results-btn" id="resetExamBtn">Reset & Try Again</button>
        <button class="results-btn" id="backToExamsBtn">Back to Exams</button>
      </div>
    </div>
  </div>

  <script src="../js/mcq-all-data.js"></script>
  <script>
    // Use Firebase instances from firebase-config.js
    let examAuth = null;
    let examDb = null;
    let examUser = null;

    // Initialize Firebase by using the already-initialized instances
    function initFirebase() {
      try {
        // Wait for firebase-config.js to load
        if (window.firebaseAuth && window.firebaseDb) {
          examAuth = window.firebaseAuth;
          examDb = window.firebaseDb;

          // Get current user
          examUser = examAuth.currentUser;

          // Listen for auth state changes
          examAuth.onAuthStateChanged((user) => {
            examUser = user;
            if (user) {
              console.log('[Exam] User signed in:', user.email);
              // Load user's exam progress from Firestore
              loadProgressFromFirestore();
            } else {
              console.log('[Exam] User signed out');
              // Fall back to localStorage
              loadProgress();
            }
          });

          console.log('[Exam] Firebase connected');
        } else {
          console.log('[Exam] Firebase not available, using localStorage only');
        }
      } catch (error) {
        console.error('[Exam] Firebase initialization error:', error);
      }
    }

    // State
    let currentQuestionIndex = 0;
    let timerStartTime = null;
    let timerInterval = null;
    let isReviewMode = false;
    let pausedElapsed = 0;

    // Timer functions
    function startTimer() {
      timerStartTime = Date.now() - pausedElapsed;
      timerInterval = setInterval(updateTimer, 1000);
    }

    function pauseTimer() {
      if (timerInterval) {
        pausedElapsed = Date.now() - timerStartTime;
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function resumeTimer() {
      if (!timerInterval) {
        startTimer();
      }
    }

    function updateTimer() {
      const elapsed = Date.now() - timerStartTime;
      const hours = Math.floor(elapsed / 3600000);
      const minutes = Math.floor((elapsed % 3600000) / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);

      const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      document.getElementById('examTimer').textContent = timeString;
    }

    // Initialize
    function initExam() {
      generateQuestionNav();
      loadQuestion(0);

      // Start the timer
      startTimer();

      // Initialize Firebase first
      initFirebase();

      // If no user is signed in after a short delay, load from localStorage
      setTimeout(() => {
        if (!examUser) {
          loadProgress();
        }
      }, 1000);
    }

    // Generate question navigation buttons
    function generateQuestionNav() {
      const navList = document.getElementById('questionNavList');
      navList.innerHTML = '';

      examData.questions.forEach((q, index) => {
        const btn = document.createElement('button');
        btn.className = 'question-nav-btn';

        // Just show the number
        btn.textContent = index + 1;

        const flagIndicator = document.createElement('span');
        flagIndicator.className = 'flag-indicator';
        flagIndicator.textContent = 'üö©';

        btn.appendChild(flagIndicator);

        if (q.selectedAnswer !== null && q.selectedAnswer !== undefined) btn.classList.add('answered');
        if (q.flagged) btn.classList.add('flagged');
        if (index === currentQuestionIndex) btn.classList.add('active');

        btn.addEventListener('click', () => loadQuestion(index));
        navList.appendChild(btn);
      });
    }

    // Load question
    function loadQuestion(index) {
      if (currentQuestionIndex !== index) {
        saveCurrentAnswer();
      }

      currentQuestionIndex = index;
      const question = examData.questions[index];

      // Build question HTML
      let html = `
        <div class="question-content-wrapper">
          <div class="question-header">
            <div class="question-number">Question ${index + 1}</div>
            <button class="flag-btn" id="flagBtn">
              <span id="flagBtnText">${question.flagged ? 'Flagged' : 'Flag Question'}</span>
            </button>
          </div>
          <div class="question-text">${question.text}</div>
          <div class="mcq-options">`;

      // Add MCQ options
      question.options.forEach((option, optIndex) => {
        const optionLetter = String.fromCharCode(65 + optIndex); // A, B, C, D, E
        const isSelected = question.selectedAnswer === optIndex;
        html += `
          <div class="mcq-option ${isSelected ? 'selected' : ''}" data-option-index="${optIndex}">
            <span class="mcq-option-label">${optionLetter}</span>
            <span>${option}</span>
            <span class="mcq-option-check">‚úì</span>
            <span class="your-answer-label">Your answer</span>
          </div>`;
      });

      html += `
          </div>
        </div>`;

      document.getElementById('questionContainer').innerHTML = html;

      // Update flag button
      const flagBtn = document.getElementById('flagBtn');
      if (flagBtn) {
        if (question.flagged) {
          flagBtn.classList.add('flagged');
        } else {
          flagBtn.classList.remove('flagged');
        }

        // Add event listener to flag button
        flagBtn.addEventListener('click', () => {
          examData.questions[currentQuestionIndex].flagged = !examData.questions[currentQuestionIndex].flagged;
          loadQuestion(currentQuestionIndex);
        });
      }

      // Add event listeners to MCQ options
      document.querySelectorAll('.mcq-option').forEach(optionEl => {
        optionEl.addEventListener('click', () => {
          const optionIndex = parseInt(optionEl.dataset.optionIndex);
          selectAnswer(optionIndex);
        });
      });

      // Update navigation buttons
      document.getElementById('prevBtn').disabled = index === 0;
      document.getElementById('nextBtn').disabled = index === examData.totalQuestions - 1;

      // If in review mode, automatically show the correct answer
      if (isReviewMode) {
        const correctIndex = question.correctAnswer;
        const correctLetter = String.fromCharCode(65 + correctIndex);
        const correctOption = question.options[correctIndex];

        // Highlight correct and incorrect answers
        document.querySelectorAll('.mcq-option').forEach((optionEl, idx) => {
          if (idx === correctIndex) {
            optionEl.classList.add('correct-highlight');
          } else if (question.selectedAnswer === idx && idx !== correctIndex) {
            optionEl.classList.add('incorrect-highlight');
          }

          // Show correct/incorrect label on student's selected answer
          if (question.selectedAnswer === idx) {
            const yourAnswerLabel = optionEl.querySelector('.your-answer-label');
            if (yourAnswerLabel) {
              if (idx === correctIndex) {
                // Correct answer
                yourAnswerLabel.innerHTML = '‚úì Correct';
                yourAnswerLabel.classList.add('correct');
              } else {
                // Incorrect answer
                yourAnswerLabel.innerHTML = '‚úó Incorrect';
                yourAnswerLabel.classList.add('incorrect');
              }
              yourAnswerLabel.classList.add('show');
            }
          }
        });

        // Disable clicking on options in review mode
        document.querySelectorAll('.mcq-option').forEach(optionEl => {
          optionEl.style.cursor = 'default';
          optionEl.onclick = null;
        });
      }

      generateQuestionNav();
      saveProgress();
    }

    // Select an answer
    function selectAnswer(optionIndex) {
      const currentSelection = examData.questions[currentQuestionIndex].selectedAnswer;

      // If clicking the same option, unselect it
      if (currentSelection === optionIndex) {
        examData.questions[currentQuestionIndex].selectedAnswer = null;

        // Remove selection from all options
        document.querySelectorAll('.mcq-option').forEach(el => {
          el.classList.remove('selected');
        });
      } else {
        // Select the new option
        examData.questions[currentQuestionIndex].selectedAnswer = optionIndex;

        // Update visual selection
        document.querySelectorAll('.mcq-option').forEach((el, idx) => {
          if (idx === optionIndex) {
            el.classList.add('selected');
          } else {
            el.classList.remove('selected');
          }
        });
      }

      saveProgress();
      generateQuestionNav();
    }

    // Save current answer
    function saveCurrentAnswer() {
      // No need to save anything as MCQ selection is handled immediately
      saveProgress();
    }

    // Debounce timer for Firestore saves
    let firestoreSaveTimeout = null;

    // Force immediate save to Firestore (used when navigating away)
    async function forceSaveProgress() {
      const progressData = {
        currentQuestionIndex,
        questions: examData.questions.map(q => ({
          id: q.id,
          selectedAnswer: q.selectedAnswer,
          flagged: q.flagged
        })),
        lastUpdated: new Date().toISOString()
      };

      // Save to localStorage
      localStorage.setItem('mcq-all-2022-2024-progress', JSON.stringify(progressData));

      // Force immediate save to Firestore
      if (examUser && examDb) {
        clearTimeout(firestoreSaveTimeout);
        try {
          await examDb.collection('users')
            .doc(examUser.uid)
            .collection('exams')
            .doc('mcq-all-2022-2024')
            .set(progressData, { merge: true });
          console.log('[Exam] Progress force-saved to Firestore');
        } catch (error) {
          console.error('[Exam] Error force-saving to Firestore:', error);
        }
      }
    }

    // Save progress to Firestore (if authenticated) or localStorage
    async function saveProgress() {
      const progressData = {
        currentQuestionIndex,
        questions: examData.questions.map(q => ({
          id: q.id,
          selectedAnswer: q.selectedAnswer,
          flagged: q.flagged
        })),
        lastUpdated: new Date().toISOString()
      };

      // Always save to localStorage immediately (fast and free)
      localStorage.setItem('mcq-all-2022-2024-progress', JSON.stringify(progressData));

      // Debounce Firestore saves to prevent quota exhaustion
      // Only save to Firestore every 10 seconds max
      if (examUser && examDb) {
        clearTimeout(firestoreSaveTimeout);
        firestoreSaveTimeout = setTimeout(async () => {
          try {
            await examDb.collection('users')
              .doc(examUser.uid)
              .collection('exams')
              .doc('mcq-all-2022-2024')
              .set(progressData, { merge: true });
            console.log('[Exam] Progress saved to Firestore');
          } catch (error) {
            console.error('[Exam] Error saving to Firestore:', error);
          }
        }, 10000); // Wait 10 seconds before saving to Firestore
      }
    }

    // Load progress from Firestore
    async function loadProgressFromFirestore() {
      if (!examUser || !examDb) return;

      try {
        const doc = await examDb.collection('users')
          .doc(examUser.uid)
          .collection('exams')
          .doc('mcq-all-2022-2024')
          .get();

        if (doc.exists) {
          const progress = doc.data();
          currentQuestionIndex = progress.currentQuestionIndex || 0;

          // Restore answers and flags
          if (progress.questions) {
            progress.questions.forEach(savedQ => {
              const question = examData.questions.find(q => q.id === savedQ.id);
              if (question) {
                question.selectedAnswer = savedQ.selectedAnswer;
                question.flagged = savedQ.flagged || false;
              }
            });
          }

          console.log('[Exam] Progress loaded from Firestore');

          // Regenerate navigation to show answered and flagged questions
          generateQuestionNav();

          loadQuestion(currentQuestionIndex);
        } else {
          // No Firestore data, check localStorage for migration
          loadProgress();
        }
      } catch (error) {
        console.error('[Exam] Error loading from Firestore:', error);
        loadProgress();
      }
    }

    // Load progress from localStorage
    function loadProgress() {
      const saved = localStorage.getItem('mcq-all-2022-2024-progress');
      if (saved) {
        const progress = JSON.parse(saved);
        currentQuestionIndex = progress.currentQuestionIndex || 0;

        // Restore answers and flags
        if (progress.questions) {
          progress.questions.forEach(savedQ => {
            const question = examData.questions.find(q => q.id === savedQ.id);
            if (question) {
              question.selectedAnswer = savedQ.selectedAnswer;
              question.flagged = savedQ.flagged || false;
            }
          });
        }

        // Regenerate navigation to show answered and flagged questions
        generateQuestionNav();

        loadQuestion(currentQuestionIndex);
      }
    }

    // Function to return to exams modal
    function returnToExams() {
      // Try to force save but don't wait - navigate immediately
      forceSaveProgress().catch(err => console.error('[Exam] Save failed on exit:', err));

      // Navigate immediately (localStorage already has the data)
      window.location.href = '../index.html#past-exams';
    }

    // Calculate and show results
    function showResults() {
      saveCurrentAnswer();

      // Calculate statistics
      let correct = 0;
      let incorrect = 0;
      let unanswered = 0;

      examData.questions.forEach(q => {
        if (q.selectedAnswer === null || q.selectedAnswer === undefined) {
          unanswered++;
        } else if (q.selectedAnswer === q.correctAnswer) {
          correct++;
        } else {
          incorrect++;
        }
      });

      // Show confirmation if there are unanswered questions
      if (unanswered > 0) {
        const confirmMessage = `You have ${unanswered} unanswered question${unanswered > 1 ? 's' : ''}. Are you sure you want to submit?`;
        if (!confirm(confirmMessage)) {
          return; // Don't submit if user cancels
        }
      }

      const score = Math.round((correct / examData.totalQuestions) * 100);

      // Update modal content
      document.getElementById('resultsScore').textContent = `Your Score: ${correct}/${examData.totalQuestions} (${score}%)`;
      document.getElementById('correctCount').textContent = correct;
      document.getElementById('incorrectCount').textContent = incorrect;
      document.getElementById('unansweredCount').textContent = unanswered;

      // Show modal
      document.getElementById('resultsModal').classList.add('show');
    }

    // Enter review mode
    function enterReviewMode() {
      isReviewMode = true;
      document.getElementById('resultsModal').classList.remove('show');
      document.getElementById('reviewModeBanner').classList.add('show');

      // Pause the timer
      pauseTimer();

      // Hide submit button and show finish review button
      document.getElementById('finishBtn').style.display = 'none';
      document.getElementById('finishReviewBtn').style.display = 'block';

      // Load first question in review mode
      loadQuestion(0);
    }

    // Exit review mode
    function exitReviewMode() {
      isReviewMode = false;
      document.getElementById('reviewModeBanner').classList.remove('show');
      document.getElementById('finishBtn').style.display = 'block';
      document.getElementById('finishReviewBtn').style.display = 'none';

      // Resume the timer
      resumeTimer();
    }

    // Reset exam
    function resetExam() {
      if (!confirm('Are you sure you want to reset the exam? All your answers will be lost.')) {
        return;
      }

      // Reset all answers
      examData.questions.forEach(q => {
        q.selectedAnswer = null;
        q.flagged = false;
      });

      // Clear saved progress
      localStorage.removeItem('mcq-all-2022-2024-progress');

      // Clear Firestore if user is signed in
      if (examUser && examDb) {
        examDb.collection('users')
          .doc(examUser.uid)
          .collection('exams')
          .doc('mcq-all-2022-2024')
          .delete()
          .catch(error => console.error('[Exam] Error deleting from Firestore:', error));
      }

      // Reset state
      currentQuestionIndex = 0;
      isReviewMode = false;

      // Hide modal and banners
      document.getElementById('resultsModal').classList.remove('show');
      document.getElementById('reviewModeBanner').classList.remove('show');
      document.getElementById('finishBtn').style.display = 'block';
      document.getElementById('finishReviewBtn').style.display = 'none';

      // Reload exam
      loadQuestion(0);
      generateQuestionNav();
    }

    // Event listeners
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentQuestionIndex > 0) {
        loadQuestion(currentQuestionIndex - 1);
      }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentQuestionIndex < examData.totalQuestions - 1) {
        loadQuestion(currentQuestionIndex + 1);
      }
    });

    document.getElementById('finishBtn').addEventListener('click', () => {
      showResults();
    });

    document.getElementById('backBtn').addEventListener('click', () => {
      returnToExams();
    });

    // Results modal button listeners
    document.getElementById('reviewAnswersBtn').addEventListener('click', () => {
      enterReviewMode();
    });

    document.getElementById('resetExamBtn').addEventListener('click', () => {
      resetExam();
    });

    document.getElementById('backToExamsBtn').addEventListener('click', () => {
      returnToExams();
    });

    // Finish review button listener
    document.getElementById('finishReviewBtn').addEventListener('click', () => {
      returnToExams();
    });

    // Auto-save every 30 seconds
    setInterval(saveCurrentAnswer, 30000);

    // Save progress when user leaves the page
    window.addEventListener('beforeunload', async (e) => {
      await forceSaveProgress();
    });

    // Check for existing progress and show modal if needed
    function checkExistingProgress() {
      const saved = localStorage.getItem('mcq-all-2022-2024-progress');
      if (saved) {
        const progress = JSON.parse(saved);
        // Check if there's any actual progress (selected answers)
        const hasProgress = progress.questions && progress.questions.some(q => q.selectedAnswer !== null && q.selectedAnswer !== undefined);

        if (hasProgress) {
          // Show modal
          const modal = document.getElementById('progressModal');
          modal.style.display = 'flex';

          // Handle continue button
          document.getElementById('continueExamBtn').addEventListener('click', () => {
            modal.style.display = 'none';
            initExam();
          });

          // Handle reset button
          document.getElementById('resetExamModalBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to reset this exam? All progress will be permanently deleted.')) {
              return;
            }

            // Clear Firestore first if available
            if (examUser && examDb) {
              try {
                await examDb.collection('users')
                  .doc(examUser.uid)
                  .collection('exams')
                  .doc('mcq-all-2022-2024')
                  .delete();
                console.log('[Exam] Progress deleted from Firestore');
              } catch (error) {
                console.error('[Exam] Error deleting from Firestore:', error);
              }
            }

            // Clear localStorage
            localStorage.removeItem('mcq-all-2022-2024-progress');
            localStorage.removeItem('mcq-all-2022-2024-completed');

            // Reset exam data in memory
            examData.questions.forEach(q => {
              q.selectedAnswer = null;
              q.flagged = false;
            });

            currentQuestionIndex = 0;
            pausedElapsed = 0;

            modal.style.display = 'none';

            // Reinitialize exam with fresh state
            generateQuestionNav();
            loadQuestion(0);
            startTimer();
          });

          return; // Don't auto-initialize
        }
      }

      // No progress found, initialize normally
      initExam();
    }

    // Initialize
    checkExistingProgress();

    // Handle donation splash screen with sound
    window.addEventListener('DOMContentLoaded', () => {
      const splash = document.getElementById('donationSplash');

      // Create a fun jingle sound using Web Audio API
      const playJingle = () => {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const now = audioContext.currentTime;

          // Create oscillator for each note
          const playNote = (frequency, startTime, duration) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            // Envelope for smooth sound
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, startTime + duration);

            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
          };

          // Play a catchy jingle (simple melody)
          playNote(523.25, now, 0.15);        // C5
          playNote(659.25, now + 0.15, 0.15); // E5
          playNote(783.99, now + 0.3, 0.15);  // G5
          playNote(1046.5, now + 0.45, 0.3);  // C6 (hold)

        } catch (error) {
          console.log('Audio playback not supported');
        }
      };

      // Play sound when splash appears
      playJingle();

      // Hide splash after 2.5 seconds with fade out animation
      setTimeout(() => {
        splash.classList.add('hide');

        // Remove from DOM after animation completes
        setTimeout(() => {
          splash.style.display = 'none';
        }, 500);
      }, 2500);
    });
  </script>
</body>
</html>
