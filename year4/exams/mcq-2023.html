<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2023 MCQ Exam - MD3 SCP</title>

  <link rel="icon" type="image/png" href="../../assets/ShepTech logo.png">
  <link rel="stylesheet" href="../../css/main.css?v=20251109-1">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase-config.js"></script>
  <script src="../../js/dark-mode.js"></script>
  <script src="../../js/access-control.js"></script>

  <style>
    /* Exam-specific styles */
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    .exam-container {
      display: flex;
      height: 100vh;
      background: var(--claude-cream);
    }

    /* Top header bar */
    .exam-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--claude-sidebar);
      border-bottom: 1px solid var(--claude-border);
      padding: 16px 40px 16px 140px;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .exam-title-section {
      display: flex;
      align-items: center;
      gap: 0;
      position: relative;
      flex: 1;
    }

    .exam-timer {
      font-family: Georgia, 'Times New Roman', serif;
      font-size: 20px;
      color: var(--claude-text);
      font-weight: 400;
      min-width: 100px;
      text-align: center;
    }

    .back-home-btn {
      position: absolute;
      left: -124px;
      padding: 8px 16px;
      background: var(--claude-card-bg);
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .back-home-btn:hover {
      background: var(--claude-light-accent);
      border-color: var(--claude-accent);
    }

    .exam-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--claude-text);
      margin: 0;
      padding-left: 0;
    }

    .exam-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .flag-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .flag-btn:hover {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.05);
    }

    .flag-btn.flagged {
      background: #ff6b6b;
      border-color: #ff6b6b;
      color: white;
    }

    /* Sidebar with question navigation */
    .exam-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 100px;
      height: 100vh;
      background: var(--claude-sidebar);
      border-right: 1px solid var(--claude-border);
      padding: 112px 16px 24px 16px;
      overflow-y: auto;
      z-index: 50;
    }

    .question-nav-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--claude-secondary);
      margin: 0 0 16px 0;
    }

    .question-nav-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .question-nav-btn {
      width: 48px;
      height: 48px;
      padding: 0;
      border: 2px solid var(--claude-border);
      background: var(--claude-card-bg);
      border-radius: 50%;
      font-size: 16px;
      font-weight: 600;
      color: var(--claude-text);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin: 0 auto;
    }

    .question-nav-btn:hover {
      border-color: #1e3a5f;
      background: rgba(30, 58, 95, 0.1);
    }

    .question-nav-btn.active {
      background: rgba(30, 58, 95, 0.1);
      color: var(--claude-text);
      border-color: #1e3a5f;
    }

    .question-nav-btn.answered {
      background: #1e3a5f;
      color: white;
      border-color: #1e3a5f;
    }

    .question-nav-btn.answered.active {
      background: #1e3a5f;
      color: white;
      border-color: #1e3a5f;
    }

    .question-nav-btn .flag-indicator {
      position: absolute;
      top: -6px;
      right: -6px;
      font-size: 18px;
      display: none;
    }

    .question-nav-btn.flagged .flag-indicator {
      display: block;
    }

    /* Main content area */
    .exam-content {
      margin-top: 72px;
      margin-left: 100px;
      width: calc(100% - 100px);
      min-width: calc(100% - 100px);
      max-width: calc(100% - 100px);
      height: calc(100vh - 72px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: fixed;
      right: 0;
    }

    .question-container {
      flex: 1;
      overflow-y: auto;
      padding: 40px;
      padding-bottom: 0;
      width: 100%;
      box-sizing: border-box;
    }

    .question-content-wrapper {
      width: 100% !important;
      max-width: 100% !important;
      min-width: 100% !important;
      display: flex !important;
      flex-direction: column !important;
      box-sizing: border-box;
    }

    .question-content-wrapper > * {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
    }

    .question-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      width: 100%;
    }

    .question-number {
      font-size: 20px;
      font-weight: 400;
      font-family: Georgia, 'Times New Roman', serif;
      color: var(--claude-text);
    }

    .question-header .flag-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .question-header .flag-btn:hover {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.05);
    }

    .question-header .flag-btn.flagged {
      background: #ff6b6b;
      border-color: #ff6b6b;
      color: white;
    }

    .question-text {
      font-size: 16px;
      line-height: 1.7;
      color: var(--claude-text);
      margin-bottom: 24px;
      padding: 24px;
      background: var(--claude-card-bg);
      border: 1px solid var(--claude-border);
      border-radius: 12px;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .question-text-content {
      flex: 1;
    }

    .question-image {
      max-width: 300px;
      max-height: 300px;
      border-radius: 8px;
      border: 1px solid var(--claude-border);
    }

    /* MCQ Options Styling */
    .mcq-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
      width: 100%;
    }

    .mcq-option {
      padding: 16px 20px;
      padding-right: 110px;
      border: 2px solid var(--claude-border);
      border-radius: 12px;
      background: var(--claude-card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
      color: var(--claude-text);
      box-sizing: border-box;
      position: relative;
    }

    .mcq-option:hover {
      border-color: #1e3a5f;
      background: rgba(30, 58, 95, 0.1);
    }

    .mcq-option.selected {
      border-color: #1e3a5f;
      background: rgba(30, 58, 95, 0.1);
      color: var(--claude-text);
    }

    .mcq-option-label {
      font-weight: 600;
      min-width: 24px;
      font-family: var(--font-sans);
    }

    .mcq-option-check {
      position: absolute;
      right: 20px;
      color: #1e3a5f;
      font-size: 20px;
      font-weight: bold;
      display: none !important;
    }

    .your-answer-label {
      position: absolute;
      right: 20px;
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font-serif);
      display: none;
      align-items: center;
      gap: 4px;
    }

    .mcq-option .your-answer-label.show {
      display: flex;
    }

    .your-answer-label.correct {
      color: #4CAF50;
    }

    .your-answer-label.incorrect {
      color: #f44336;
    }

    .mcq-option.correct-highlight {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.2);
      font-weight: 600;
    }

    .mcq-option.incorrect-highlight {
      border-color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }

    /* Show Answer Section */
    .show-answer-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--claude-border);
    }

    .show-answer-btn {
      padding: 10px 20px;
      background: var(--claude-card-bg);
      border: 2px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .show-answer-btn:hover {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }

    .correct-answer-display {
      margin-top: 16px;
      padding: 16px;
      background: rgba(76, 175, 80, 0.1);
      border: 2px solid #4CAF50;
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 15px;
    }

    .correct-answer-display strong {
      color: #4CAF50;
    }

    .question-actions {
      display: flex;
      justify-content: space-between;
      padding: 24px 40px;
      border-top: 1px solid var(--claude-border);
      background: var(--claude-sidebar);
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .nav-buttons-left {
      display: flex;
      gap: 12px;
    }

    .nav-btn {
      padding: 12px 24px;
      background: var(--claude-card-bg);
      border: 1.5px solid var(--claude-border);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .nav-btn:hover:not(:disabled) {
      background: var(--claude-light-accent);
      border-color: var(--claude-accent);
    }

    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .nav-btn.primary {
      background: #1e3a5f;
      color: white;
      border-color: #1e3a5f;
    }

    .nav-btn.primary:hover:not(:disabled) {
      background: #0A2540;
    }

    .finish-btn {
      padding: 12px 24px;
      background: #1e3a5f;
      border: 1.5px solid #1e3a5f;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .finish-btn:hover {
      background: #0A2540;
      border-color: #0A2540;
    }

    /* Results Modal */
    .results-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .results-modal.show {
      display: flex;
    }

    .results-content {
      background: var(--claude-card-bg);
      border-radius: 16px;
      padding: 40px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .results-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .results-header h2 {
      color: var(--claude-text);
      font-size: 32px;
      margin: 0 0 16px 0;
    }

    .results-score {
      font-size: 48px;
      font-weight: bold;
      color: #4CAF50;
      margin: 16px 0;
    }

    .results-stats {
      display: flex;
      justify-content: space-around;
      margin: 24px 0;
      padding: 20px;
      background: var(--claude-bg);
      border-radius: 12px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: var(--claude-text);
    }

    .stat-label {
      font-size: 14px;
      color: var(--claude-muted);
      margin-top: 4px;
    }

    .results-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 32px;
    }

    .results-btn {
      padding: 14px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid var(--claude-border);
      background: var(--claude-card-bg);
      color: var(--claude-text);
    }

    .results-btn.primary {
      background: #1e3a5f;
      border-color: #1e3a5f;
      color: white;
    }

    .results-btn.primary:hover {
      background: #0A2540;
      border-color: #0A2540;
    }

    .results-btn:hover {
      border-color: #1e3a5f;
      background: rgba(30, 58, 95, 0.1);
    }

    /* Review Mode */
    .review-mode-banner {
      display: none;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--claude-border);
      border-radius: 0;
      padding: 8px 20px;
      margin-bottom: 16px;
      text-align: left;
      color: var(--claude-secondary);
      font-weight: 500;
      font-size: 13px;
    }

    .review-mode-banner.show {
      display: block;
    }
    /* Progress Check Modal */
    .progress-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      justify-content: center;
      align-items: center;
    }

    .progress-modal-content {
      background: var(--claude-card-bg);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .progress-modal h2 {
      margin: 0 0 16px 0;
      font-size: 24px;
      color: var(--claude-text);
      font-family: Georgia, 'Times New Roman', serif;
    }

    .progress-modal p {
      margin: 0 0 24px 0;
      font-size: 16px;
      color: var(--claude-secondary);
      line-height: 1.5;
    }

    .progress-modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .progress-modal-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1.5px solid;
    }

    .progress-modal-btn.reset {
      background: white;
      border-color: var(--claude-border);
      color: var(--claude-text);
    }

    .progress-modal-btn.reset:hover {
      background: var(--claude-light-accent);
      border-color: var(--claude-accent);
    }

    .progress-modal-btn.continue {
      background: #1e3a5f;
      border-color: #1e3a5f;
      color: white;
    }

    .progress-modal-btn.continue:hover {
      background: #0A2540;
      border-color: #0A2540;
    }

    .no-answer-notice {
      margin-top: 24px;
      padding: 16px;
      background: rgba(255, 152, 0, 0.1);
      border: 1px solid rgba(255, 152, 0, 0.3);
      border-radius: 8px;
      color: var(--claude-text);
      font-size: 14px;
      text-align: center;
      display: none;
    }

    .no-answer-notice.show {
      display: block;
    }

  </style>
  <script src="../../js/user-analytics.js"></script>
  <script src="../../js/exam-page-tracker.js"></script>
</head>
<body>
  <!-- Progress Check Modal -->
  <div class="progress-modal" id="progressModal">
    <div class="progress-modal-content">
      <h2>Continue Exam?</h2>
      <p>Would you like to continue where you left off, or reset and start a new attempt?</p>
      <div class="progress-modal-buttons">
        <button class="progress-modal-btn reset" id="resetExamBtn">Reset Exam</button>
        <button class="progress-modal-btn continue" id="continueExamBtn">Continue Current Attempt</button>
      </div>
    </div>
  </div>

  <div class="exam-container">
    <!-- Top header bar -->
    <div class="exam-header">
      <div class="exam-title-section">
        <button class="back-home-btn" id="backBtn">
          <span>←</span> Back
        </button>
        <h1 class="exam-title">2023 MCQ Exam</h1>
      </div>

      <div class="exam-actions">
        <div class="exam-timer" id="examTimer">00:00:00</div>
      </div>
    </div>

    <!-- Sidebar with question navigation -->
    <div class="exam-sidebar">
      <div class="question-nav-list" id="questionNavList">
        <!-- Question buttons will be generated by JavaScript -->
      </div>
    </div>

    <!-- Main content -->
    <div class="exam-content">
      <div class="review-mode-banner" id="reviewModeBanner">
        Review Mode - Answers not yet available for this exam
      </div>
      <div class="question-container" id="questionContainer">
        <!-- Question content will be loaded here -->
      </div>

      <div class="question-actions">
        <div class="nav-buttons-left">
          <button class="nav-btn" id="prevBtn">← Previous</button>
          <button class="nav-btn primary" id="nextBtn">Next →</button>
        </div>
        <button class="finish-btn" id="finishBtn">Finish Exam</button>
        <button class="finish-btn" id="finishReviewBtn" style="display: none;">Finish Review</button>
      </div>

      <div class="no-answer-notice" id="noAnswerNotice">
        Note: Correct answers are not yet available for this exam. Your responses are being saved for your records.
      </div>
    </div>
  </div>

  <!-- Results Modal -->
  <div class="results-modal" id="resultsModal">
    <div class="results-content">
      <div class="results-header">
        <h2>Exam Complete!</h2>
        <p style="color: var(--claude-secondary); font-size: 16px; margin-top: 16px;">Answers are not yet available for this exam. Your responses have been saved.</p>
      </div>

      <div class="results-stats">
        <div class="stat-item">
          <div class="stat-value" id="answeredCount">0</div>
          <div class="stat-label">Answered</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="unansweredCount">0</div>
          <div class="stat-label">Unanswered</div>
        </div>
      </div>

      <div class="results-actions">
        <button class="results-btn primary" id="reviewAnswersBtn">Review Answers</button>
        <button class="results-btn" id="resetExamBtn2">Reset & Try Again</button>
        <button class="results-btn" id="backToExamsBtn">Back to Exams</button>
      </div>
    </div>
  </div>

  <script>
    // Use Firebase instances from firebase-config.js
    let examAuth = null;
    let examDb = null;
    let examUser = null;

    // Initialize Firebase by using the already-initialized instances
    function initFirebase() {
      try {
        // Wait for firebase-config.js to load
        if (window.firebaseAuth && window.firebaseDb) {
          examAuth = window.firebaseAuth;
          examDb = window.firebaseDb;

          // Get current user
          examUser = examAuth.currentUser;

          // Listen for auth state changes
          examAuth.onAuthStateChanged((user) => {
            examUser = user;
            if (user) {
              console.log('[Exam] User signed in:', user.email);
              // Load user's exam progress from Firestore
              loadProgressFromFirestore();
            } else {
              console.log('[Exam] User signed out');
              // Fall back to localStorage
              loadProgress();
            }
          });

          console.log('[Exam] Firebase connected');
        } else {
          console.log('[Exam] Firebase not available, using localStorage only');
        }
      } catch (error) {
        console.error('[Exam] Firebase initialization error:', error);
      }
    }

    // Exam data - 92 Questions from 2023 Y3 Dump
    const examData = {
      title: '2023 MCQ Exam',
      totalQuestions: 92,
      questions: [
        {
          id: 1,
          text: "Child presents to the GP clinic with a purulent malodorous vaginal discharge. Which one of the following is the most likely diagnosis?",
          options: ["Bacterial vaginosis", "Foreign body in vagina", "Sexual abuse", "Candidiasis"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 2,
          text: "Person had bowed legs, what would you see on xray? Think the stem was describing a patient with Paget's disease.",
          options: ["Lytic lesions", "Widened epiphyseal plates", "Diffuse osteosclerosis", "Metaphyseal cupping"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 3,
          text: "Which organism caused fever symptoms, diarrhoea & blood in stool?",
          options: ["Salmonella", "E. coli", "Campylobacter", "Rotavirus"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 4,
          text: "Man with hypersplenism has a splenectomy. For how many years are they at increased risk of infection?",
          options: ["5-10 years", "Less than 1 year", "More than 10 years", "1-2 years"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 5,
          text: "3-year-old child had maroon stool and hypotension, what's the diagnosis?",
          options: ["Meckel's diverticulum", "Angiodysplasia", "UC", "Diverticular disease"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 6,
          text: "Treatment of epiglottis, boy has drooling.",
          options: ["IV antibiotics", "Nebulized salbutamol", "Inhaled adrenaline", "Systemic steroids"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 7,
          text: "Elderly woman who is 'mentally alert' from nursing home. Symptoms of bowel obstruction (bilious vomit). Her abdomen is distended, but non-tender. You notice a tender lump in her groin, below the inguinal ligament, on examination. Already has NG and IV fluids. What is the next appropriate step in management?",
          options: ["Ultrasound of lump", "Continue conservative management", "Surgical referral", "CT abdomen"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 8,
          text: "What is shown on this Xray?",
          options: ["Ileus", "Large bowel obstruction", "Sigmoid volvulus", "Small bowel obstruction"],
          hasImage: true,
          imageUrl: "../Q8. SigVolv 2023 MCQ.png",
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 9,
          text: "Woman has low folate levels, what could they be at risk of?",
          options: ["Bleeding disorder", "Neural tube defect", "Anaemia only", "Thrombocytopenia"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 10,
          text: "Heart murmur and back pain, which investigation would confirm the diagnosis?",
          options: ["Anti-CCP", "RF", "HLA-B27", "ESR"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 11,
          text: "Grade 2 systolic murmur on left sternal edge, 2nd heart sound split. What is the diagnosis?",
          options: ["ASD", "VSD", "Pulmonary valve stenosis", "Aortic stenosis"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 12,
          text: "Girl with red rash spread to throat. Slapped-cheek rash with sparing nasolabial folds.",
          options: ["Roseola", "Erythema infectiosum", "Scarlet fever", "Rubella"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 13,
          text: "Which vaccination would you give for pregnant woman in addition to influenza?",
          options: ["Pneumococcal", "HPV", "DTP (dTpa)", "Varicella"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 14,
          text: "Crocodile tears syndrome is caused by which nerve?",
          options: ["Glossopharyngeal", "Trigeminal", "Facial nerve", "Oculomotor"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 15,
          text: "Person is convinced that they have HIV seen 3 doctors, no symptoms, all negative test results - what condition?",
          options: ["Somatic symptom disorder", "Illness anxiety disorder", "Hypochondriasis", "Generalised anxiety disorder"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 16,
          text: "Person described with PCOS symptoms, when to do FSH/LH test?",
          options: ["Day 3-5 of menstrual cycle", "Today", "1 week", "3 days"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 17,
          text: "One twin has oligohydramnios the other polyhydramnios, what is the reason for this?",
          options: ["Placental insufficiency", "Twin to twin transfusion syndrome", "Different growth rates", "Chromosomal abnormality"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 18,
          text: "ABG given with metabolic acidosis, kid had fever. What is likely?",
          options: ["Renal tubular acidosis", "Diabetic ketoacidosis", "Salicylate poisoning", "Sepsis"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 19,
          text: "Amenorrhea, increased urinary frequency at 8 weeks, 2 past ectopic pregnancy. What is the reason for this episode of amenorrhoea?",
          options: ["Normal pregnancy", "Ovarian cyst", "Ectopic pregnancy", "PID"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 20,
          text: "Person with facial drooping, facial muscle weakness, hearing loss. Where is the lesion?",
          options: ["Internal auditory meatus", "Pontine angle", "Stylomastoid foramen", "Inferior pons"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 21,
          text: "Floppy 10 month old child, loss of neck tone, fasiculations present. Where is the lesion?",
          options: ["Peripheral nerve", "Neuromuscular junction", "Anterior horn", "Upper motor neuron"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 22,
          text: "Person with Addison's what is the treatment?",
          options: ["IV hydrocortisone only", "Increase both", "Increase hydrocortisone & leave fludrocortisone", "Increase fludrocortisone & leave hydrocortisone"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 23,
          text: "Patient had amenorrhoea, cold peripheries, bradycardia, HR 60bpm, BMI 16 what caused this?",
          options: ["PCOS", "Addison's disease", "Anorexia nervosa", "Hypothyroidism"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 24,
          text: "Which combination of medication causes proximal myopathy and muscle weakness?",
          options: ["Perindopril and celecoxib", "Perindopril and amiloride", "Perindopril and paracetamol", "Perindopril and indapamide"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 25,
          text: "Person with gout recently started on antihypertensive but can't remember the name - which type of antihypertensive is most likely to have precipitated the gout flare?",
          options: ["Beta blocker", "CCB", "Thiazide diuretic", "Loop diuretic"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 26,
          text: "Girl who's captain of a netball team has abdominal pain colicky and intermittent during the day. Growth is normal (50-70th percentile), what does she have?",
          options: ["Constipation", "Functional abdominal pain", "IBS", "Abdominal migraine"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 27,
          text: "Farm worker's wife is concerned because her husband has social withdrawal, high alcohol intake (2 drinks per night), not motivated, not eating. She suspects severe depression. What is the management?",
          options: ["Mirtazapine", "SSRI", "CBT", "Men's support group"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 28,
          text: "Which medication is safe to use in pregnancy for person who has bipolar disorder?",
          options: ["Carbamazepine", "Olanzapine", "Lamotrigine", "Sodium valproate"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 29,
          text: "Woman presents to ED with back pain, rated 4/10. She is also anxious because a colleague was fired or quit because of a back injury. Which of the following is most likely to predispose to chronic pain syndrome?",
          options: ["Pain scale 4/10", "Being female", "Anxiety around employment", "No previous injuries"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 30,
          text: "Person hasn't opened bowel for 5 days and no flatus for 2 days. What investigation to order?",
          options: ["Gastrograffin enema", "Abdo xray", "Three phase CT", "CT with contrast"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 31,
          text: "45 M with pleuritic chest pain but no SOB. ECG showing widespread ST elevation. 'Low grade fever' of 37.3. What is the diagnosis?",
          options: ["MI", "Constrictive pericarditis", "Acute pericarditis", "Chronic pericarditis"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 32,
          text: "Middle aged man with previous infarct, sudden onset palpitations and tachycardia, also had 15-hour flight over a week ago. ECG shows atrial fibrillation. What is the next investigation?",
          options: ["Troponin", "Echo", "TSH", "D-Dimer"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 33,
          text: "Woman 33, been contacted with possibly having come in contact with chlamydia, what is the best way to reduce spread in the community?",
          options: ["Test for reinfection in 3-6 months", "Use condoms", "Contact her partners", "Give her azithromycin"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 34,
          text: "Uni student comes in asking for sleeping pills & reports decreased attendance of class, insomnia, low mood at start of the week, admits to using drugs on weekend, what is the likely cause?",
          options: ["Drug seeking behaviour", "Depression", "Stimulant substance abuse", "Alcohol"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 35,
          text: "Child with bleeding gums, rash and prolonged PT and PTT, what combination of factors is the likely cause?",
          options: ["DIC", "Factor VIII deficiency", "II/VII/IX/X", "Von Willebrand factor"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 36,
          text: "Woman has breast cancer biopsy for a lump. Biopsy comes back indicating a tumor with fat cells, stromal cells, epithelial cells. What is management?",
          options: ["Review", "Radical mastectomy", "Local excision", "Simple mastectomy"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 37,
          text: "Woman with 1.8cm cyst on ovary on day 12 of cycle i.e., just before ovulation - what is the next step for management?",
          options: ["Cyst biopsy", "Follow up ultrasound in 3 weeks", "Observation only", "CA 125 levels"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 38,
          text: "Patient had post-tibial fixation and now has 8 hours of pain, passive dorsiflexion of foot increases pain. What is the management?",
          options: ["Analgesia", "Raise the leg", "Calf fasciotomy", "Review in 2 hours"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 39,
          text: "Older person has hyperinflated chest and SOB with 40 pack year smoking history (seemed like a COPD picture), what is the next step of management?",
          options: ["ABG", "CT chest", "Spirometry", "Chest X-Ray"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 40,
          text: "Person is on a number of different medications and has a hypoglycaemic episode. Ceasing which medication would likely increase her awareness of a hypoglcaemic episode in the future?",
          options: ["Gliclazide", "Insulin", "Atenolol", "Metformin"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 41,
          text: "Girl presents with long standing dog phobia. wants to work on it because her boyfriend has a German Shepherd. What is the best treatment method?",
          options: ["Exposure therapy with systematic desensitization", "Show her pictures of dogs", "Ask her to make a diary of all the dogs she comes across", "Ask her to buy a small dog for a pet"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 42,
          text: "Fundoscopy showing cotton wool spots, microaneurysms, AV nipping, hard exudates, and dot and blot haemorrhages. What is the most likely cause?",
          options: ["T2DM", "Both T2DM and hypertension", "Central retinal vein occlusion", "Hypertension"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 43,
          text: "4.5 cm abdominal aortic aneurysm. How would you monitor?",
          options: ["CT angiogram", "Serial clinical assessments", "MRI", "Duplex ultrasound"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 44,
          text: "4-month boy comes in because parents think his scrotum is swollen. On examination, it was not swollen, although one spermatic cord is larger than the other. What would you do?",
          options: ["Tell parent there is no lump and reassure", "Urgent surgery", "Do an ultrasound of the scrotum and inguinal canal", "Ask them to come back when the lump presents"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 45,
          text: "Male patient had heart failure on frusemide with swollen, red knee post-treatment for heart failure but afebrile. What do you expect to see on joint aspiration?",
          options: ["RBCs", "Neutrophils", "Crystals", "Gram positive organism"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 46,
          text: "Patient described having shortness of breath on exertion, palpitations, chest pain, recent long flight about a week ago. What would be the next investigation you would do?",
          options: ["D-dimer", "CTPA", "Echo", "ECG"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 47,
          text: "Person described with symptoms of temporal arteritis (e.g., jaw claudication) - what is the next step in management?",
          options: ["Carbamazepine", "NSAID", "Prednisolone", "Temporal artery biopsy"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 48,
          text: "Man presents with a change in their exercise tolerance. There is nil dyspnoea at rest, however exertional dyspnoea whilst walking 100m to their mailbox. What NYHA rating are they?",
          options: ["II", "I", "IV", "III"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 49,
          text: "Footballer with pain on knee extension and small effusion. Cause?",
          options: ["Meniscal injury", "MCL injury", "ACL", "Patellar fracture"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 50,
          text: "44yo woman hasn't had a period in 3 months, but her two periods before now were abnormally heavy - what is your initial investigation?",
          options: ["Pelvic ultrasound", "LH+FSH", "Mid-luteal progesterone", "bHCG"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 51,
          text: "Patient has an abdominal mass extending from xiphisternum to umbilicus, but only when sitting up. Doesn't happen when coughing or straining. Cause?",
          options: ["Umbilical hernia", "Epigastric hernia", "Divarication of rectus abdominis", "Lipoma of anterior abdominal wall"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 52,
          text: "Which is the most appropriate hormonal regimen for a 56-year old postmenopausal woman with a uterus who has many menopausal symptoms?",
          options: ["Cyclical oestrogen and progestogen", "Continuous oestrogen alone", "Continuous oestrogen and continuous progestogen", "Cyclical oestrogen alone"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 53,
          text: "Young woman who had multiple abusive relationships, was bullied in school, dissociates sometimes, binge eats and gambles when stressed. Sometimes feels out of her body. Now she lives with her mum and symptoms are better. What is the diagnosis?",
          options: ["Borderline personality disorder", "Attachment disorder", "Dependent personality disorder", "Bipolar disorder"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 54,
          text: "Chest pain with radiation to arm. Radial pulse on one side present, but not present on the other. Likely diagnosis?",
          options: ["Anterolateral AMI", "Inferior AMI", "Aortic dissection", "PE"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 55,
          text: "Young woman with chest pain and headache. Neurologist is reviewing notes as sees frequent admissions at different hospitals for chest pain, dysmenorrhoea, constipation and diarrhoea, headache. Normal bloods on admission. Got worse about 3 years ago when she was laid off her job for missing too many shifts because of being sick and is now getting employment benefits. Dx?",
          options: ["Endometriosis", "Somatic symptom disorder", "IBS", "Factitious disorder"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 56,
          text: "Person with longstanding GORD and Barrett's - what type of oesophageal cancer are they likely to get?",
          options: ["Squamous cell carcinoma", "Lymphoma", "Small cell", "Adenocarcinoma"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 57,
          text: "10-year-old with low RBC (90), elevated WCC (200,000), low platelets (15,000) and mediastinal mass. What are his lab findings suggestive of?",
          options: ["Acute myeloid leukaemia", "Hodgkin's lymphoma", "Chronic myeloid leukaemia", "Acute lymphocytic leukaemia"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 58,
          text: "Patient with weakness, which of the following additional signs would suggest MS?",
          options: ["Optic neuritis", "Peripheral neuropathy", "Ataxia only", "Intention tremor only"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 59,
          text: "Man in cardiac ward with difficulty speaking, takes him a while to get words out. You can understand what he's saying. What is the cause?",
          options: ["Sensory aphasia (Wernicke's)", "Dysarthria", "Motor aphasia (Broca's)", "Apraxia"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 60,
          text: "Old man has 2-month history of epigastric pain. He drinks a lot of alcohol, smokes a lot, lost 6 kg of weight, anorexia and vomiting. Succussion splash observed on examination. What's the most likely diagnosis?",
          options: ["Pancreatic pseudocyst", "Carcinoma of the stomach", "Chronic duodenal ulcer", "Alcoholic liver disease"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 61,
          text: "A male with pleuritic chest pain, recurrence every 5-10 min and a cough at night. What is the most likely diagnosis?",
          options: ["COPD", "Pneumonia", "Pleurisy", "GORD"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 62,
          text: "Young woman presented with routine check-up. Her bloods showed hypercalcaemia (2.60) and normal electrolytes/creatinine (EUC), normal ALP, normal FBC. What is the likely cause of hypercalcaemia?",
          options: ["Primary hyperparathyroidism", "Iatrogenic from prolonged tourniquet", "Malignancy", "High dietary calcium intake"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 63,
          text: "Management of septic knee what is the next step in management?",
          options: ["Joint washout", "Xray", "Joint aspiration", "Antibiotics"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 64,
          text: "OSA symptoms, what is the next step in management?",
          options: ["Weight loss", "Sleep study", "ENT referral", "CPAP trial"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 65,
          text: "Patient wanting to know about prostate cancer risk, what is the next appropriate step?",
          options: ["Giving risk advice", "Talk to patient about pros and cons", "Doing DRE and PSA", "Immediate PSA"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 66,
          text: "11-year-old had symptoms of testicular torsion while playing cricket, and progressively has had worsening symptoms. Unable to properly examine as was too painful. What would be appropriate management?",
          options: ["Advise to wait a week", "Analgesia and review", "Ultrasound of testes", "Immediate surgical exploration"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 67,
          text: "Man unable to play golf anymore as he has calf pain after 100m of walking. 90% stenosis of the femoral artery. On imaging it was found to be 2cm in length. What is the appropriate management?",
          options: ["Anti-platelet therapy", "Femoral popliteal bypass", "Encourage exercise", "Angioplasty balloon and stent"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 68,
          text: "Woman has had straw coloured vaginal discharge, seen on speculum exam, after antepartum haemorrhage 3 weeks prior. She had sexual intercourse last night. Most likely diagnosis?",
          options: ["Urinary incontinence", "Residual discharge from antepartum haemorrhage", "Post-coital fluid", "Membrane rupture"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 69,
          text: "Man with signs of aortic regurgitation, heart failure with dyspnoea on minimal exertion, ejection fraction of <40%. Best management option?",
          options: ["12/12 monitoring", "Ramipril 2x daily", "Aortic valve replacement", "6/12 echo monitoring"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 70,
          text: "6 hours post op thyroidectomy for toxic multinodular goitre, woman suddenly becomes aggressive, confused. What is the diagnosis?",
          options: ["Thyrotoxic crisis", "Neuroleptic malignant syndrome", "Hypocalcaemia", "Post-op delirium"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 71,
          text: "Fijian NESB woman in ED with shortness of breath. Xray and lateral CT shows right middle lobe pneumonia. What is the appropriate treatment?",
          options: ["IV Frusemide", "Lateral aspiration", "IV Antibiotics", "Anterior aspiration"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 72,
          text: "4-year-old kid with swollen eyes, oedema on legs. Appropriate management?",
          options: ["Prednisolone", "Frusemide", "Restrict protein in diet", "Albumin infusion"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 73,
          text: "3-year-old with bed wetting. Next appropriate management?",
          options: ["Desmopressin", "Bed and pad alarm", "Reassure parents that this is developmentally normal for the age", "Restrict fluid after 6pm"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 74,
          text: "Male with Parkinson's, 3-year history of falls, sleep disturbance, and seeing/talking to people and dog around the house that aren't there. On many medications. What's the cause?",
          options: ["Parkinson's disease dementia", "Lewy Body dementia", "Late onset psychosis", "Medication side effect"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 75,
          text: "X-ray of left sided pleural effusion, guy also had crackles to the midzone & risk factors for heart failure, no fever, weight loss. What's the next investigation?",
          options: ["CTPA", "Lateral aspiration", "Frusemide", "Echo"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 76,
          text: "Older woman with previous infarct evident by Q waves on ECG, dyspnoea on exertion. What investigation?",
          options: ["BNP", "Echo", "Stress test", "Coronary angiogram"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 77,
          text: "Young kid with petechiae and bruising over body. What's the next investigation?",
          options: ["FBC", "Coagulation profile", "Bone marrow biopsy", "Skeletal survey"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 78,
          text: "Woman with back pain radiating to her leg (radiculopathy), no other neurological symptoms, already gave her analgesia. What is the next step in management?",
          options: ["Physiotherapy", "Normal activities", "Imaging", "Bed rest"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 79,
          text: "4-month-old child with bronchiolitis, normal O2 saturations, hydrated and well but mild subcostal retractions. What's the management?",
          options: ["Steroids", "Antibiotics", "Supportive", "Salbutamol"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 80,
          text: "25-year-old woman with CIN2 (cervical intraepithelial neoplasia grade 2) on CST. What is the next step in management?",
          options: ["LEEP", "Hysterectomy", "Colposcopy and biopsy", "Repeat in 6 months"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 81,
          text: "36-year-old woman with dyspareunia had a total hysterectomy & salpingo-oophorectomy. What medication can she have?",
          options: ["SERM", "Progesterone only", "Oestrogen replacement", "Combined HRT"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 82,
          text: "Girl with loin pain. What is the diagnosis?",
          options: ["Pyonephrosis", "Renal calculi", "Pyelonephritis", "UTI"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 83,
          text: "Best investigation for a thickened vas deferens?",
          options: ["Biopsy", "MRI", "CT", "U/S"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 84,
          text: "Down syndrome child with a soft non-tender abdomen.",
          options: ["Hirschsprung disease", "Pyloric stenosis", "Duodenal atresia", "Intussusception"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 85,
          text: "9 month old infant with 10 minutes of many head bobbing, flexing of trunk and extension of arms. No neurodevelopment delay.",
          options: ["Infantile spasms", "Febrile convulsions", "Atonia", "Tics"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 86,
          text: "Infant brought in because head wasn't being supported by neck muscles. Had fasciculations, no deep tendon reflexes.",
          options: ["Peripheral neuropathy", "Neuromuscular junction disorder", "Anterior horn disease", "Muscle disease"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 87,
          text: "Kid with high fever, tonsils exudate, hepatosplenomegaly and rash. What would you investigation be?",
          options: ["Monospot test", "Anti-streptolysin titre", "Immature white blood cells on blood film", "FBC only"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 88,
          text: "Kid at friends place, gets urticarial rash, no other signs of anaphylaxis. Treat with?",
          options: ["Steroid cream", "IM adrenaline", "Oral antihistamine", "Observation"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 89,
          text: "CXR with pleural effusion in middle zone, not in inferior. Showed both the anterior and lateral view. What would you do?",
          options: ["Lateral chest drain", "Steroid", "Anterior chest drain", "Antibiotics"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 90,
          text: "Lady presents recurrent hx of falls for 2 weeks. Has postural hypotension and DM. Febrile. No neurological examination. MMSE 27/30. Most immediate next step of management?",
          options: ["CT brain", "ECG", "Repeat blood pressure", "Urinalysis"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 91,
          text: "Young lady on escitalopram, passed the trial, still agitated. Started mirtazapine, quetiapine. On examination fever, signs of neurological disturbances.",
          options: ["Sepsis", "Neuroleptic malignant syndrome", "Drug interaction", "Serotonin syndrome"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        },
        {
          id: 92,
          text: "Kid with nephrotic syndrome picture what do you treat with?",
          options: ["Prednisolone", "ACE inhibitor", "Albumin", "Frusemide"],
          hasImage: false,
          selectedAnswer: null,
          flagged: false
        }
      ]
    };

    // State
    let currentQuestionIndex = 0;
    let timerStartTime = null;
    let timerInterval = null;
    let isReviewMode = false;
    let pausedElapsed = 0;

    // Timer functions
    function startTimer() {
      timerStartTime = Date.now() - pausedElapsed;
      timerInterval = setInterval(updateTimer, 1000);
    }

    function pauseTimer() {
      if (timerInterval) {
        pausedElapsed = Date.now() - timerStartTime;
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function resumeTimer() {
      if (!timerInterval) {
        startTimer();
      }
    }

    function updateTimer() {
      const elapsed = Date.now() - timerStartTime;
      const hours = Math.floor(elapsed / 3600000);
      const minutes = Math.floor((elapsed % 3600000) / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);

      const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      document.getElementById('examTimer').textContent = timeString;
    }

    // Initialize
    function initExam() {
      generateQuestionNav();
      loadQuestion(0);

      // Start the timer
      startTimer();

      // Initialize Firebase first
      initFirebase();

      // If no user is signed in after a short delay, load from localStorage
      setTimeout(() => {
        if (!examUser) {
          loadProgress();
        }
      }, 1000);
    }

    // Generate question navigation buttons
    function generateQuestionNav() {
      const navList = document.getElementById('questionNavList');
      navList.innerHTML = '';

      examData.questions.forEach((q, index) => {
        const btn = document.createElement('button');
        btn.className = 'question-nav-btn';

        // Just show the number
        btn.textContent = index + 1;

        const flagIndicator = document.createElement('span');
        flagIndicator.className = 'flag-indicator';
        flagIndicator.textContent = '🚩';

        btn.appendChild(flagIndicator);

        if (q.selectedAnswer !== null && q.selectedAnswer !== undefined) btn.classList.add('answered');
        if (q.flagged) btn.classList.add('flagged');
        if (index === currentQuestionIndex) btn.classList.add('active');

        btn.addEventListener('click', () => loadQuestion(index));
        navList.appendChild(btn);
      });
    }

    // Load question
    function loadQuestion(index) {
      if (currentQuestionIndex !== index) {
        saveCurrentAnswer();
      }

      currentQuestionIndex = index;
      const question = examData.questions[index];

      // Build question HTML
      let html = `
        <div class="question-content-wrapper">
          <div class="question-header">
            <div class="question-number">Question ${index + 1}</div>
            <button class="flag-btn" id="flagBtn">
              <span id="flagBtnText">${question.flagged ? 'Flagged' : 'Flag Question'}</span>
            </button>
          </div>
          <div class="question-text">
            <div class="question-text-content">${question.text}</div>`;

      // Add image if this is question 8
      if (question.hasImage && question.imageUrl) {
        html += `<img src="${question.imageUrl}" alt="Question image" class="question-image">`;
      }

      html += `</div><div class="mcq-options">`;

      // Add MCQ options
      question.options.forEach((option, optIndex) => {
        const optionLetter = String.fromCharCode(65 + optIndex); // A, B, C, D
        const isSelected = question.selectedAnswer === optIndex;
        html += `
          <div class="mcq-option ${isSelected ? 'selected' : ''}" data-option-index="${optIndex}">
            <span class="mcq-option-label">${optionLetter}</span>
            <span>${option}</span>
            <span class="mcq-option-check">✓</span>
            <span class="your-answer-label">Your answer</span>
          </div>`;
      });

      html += `</div>`;
      html += `</div>`;

      document.getElementById('questionContainer').innerHTML = html;

      // Update flag button
      const flagBtn = document.getElementById('flagBtn');
      if (flagBtn) {
        if (question.flagged) {
          flagBtn.classList.add('flagged');
        } else {
          flagBtn.classList.remove('flagged');
        }

        // Add event listener to flag button
        flagBtn.addEventListener('click', () => {
          examData.questions[currentQuestionIndex].flagged = !examData.questions[currentQuestionIndex].flagged;
          loadQuestion(currentQuestionIndex);
        });
      }

      // Add event listeners to MCQ options
      document.querySelectorAll('.mcq-option').forEach(optionEl => {
        optionEl.addEventListener('click', () => {
          const optionIndex = parseInt(optionEl.dataset.optionIndex);
          selectAnswer(optionIndex);
        });
      });

      // Update navigation buttons
      document.getElementById('prevBtn').disabled = index === 0;
      document.getElementById('nextBtn').disabled = index === examData.totalQuestions - 1;

      generateQuestionNav();
      saveProgress();
    }

    // Select an answer
    function selectAnswer(optionIndex) {
      const currentSelection = examData.questions[currentQuestionIndex].selectedAnswer;

      // If clicking the same option, unselect it
      if (currentSelection === optionIndex) {
        examData.questions[currentQuestionIndex].selectedAnswer = null;

        // Remove selection from all options
        document.querySelectorAll('.mcq-option').forEach(el => {
          el.classList.remove('selected');
        });
      } else {
        // Select the new option
        examData.questions[currentQuestionIndex].selectedAnswer = optionIndex;

        // Update visual selection
        document.querySelectorAll('.mcq-option').forEach((el, idx) => {
          if (idx === optionIndex) {
            el.classList.add('selected');
          } else {
            el.classList.remove('selected');
          }
        });
      }

      saveProgress();
      generateQuestionNav();
    }

    // Save current answer
    function saveCurrentAnswer() {
      // No need to save anything as MCQ selection is handled immediately
      saveProgress();
    }

    // Debounce timer for Firestore saves
    let firestoreSaveTimeout = null;

    // Force immediate save to Firestore (used when navigating away)
    async function forceSaveProgress() {
      const progressData = {
        currentQuestionIndex,
        questions: examData.questions.map(q => ({
          id: q.id,
          selectedAnswer: q.selectedAnswer,
          flagged: q.flagged
        })),
        lastUpdated: new Date().toISOString()
      };

      // Save to localStorage
      localStorage.setItem('mcq-2023-progress', JSON.stringify(progressData));

      // Force immediate save to Firestore
      if (examUser && examDb) {
        clearTimeout(firestoreSaveTimeout);
        try {
          await examDb.collection('users')
            .doc(examUser.uid)
            .collection('exams')
            .doc('mcq-2023')
            .set(progressData, { merge: true });
          console.log('[Exam] Progress force-saved to Firestore');
        } catch (error) {
          console.error('[Exam] Error force-saving to Firestore:', error);
        }
      }
    }

    // Save progress to Firestore (if authenticated) or localStorage
    async function saveProgress() {
      const progressData = {
        currentQuestionIndex,
        questions: examData.questions.map(q => ({
          id: q.id,
          selectedAnswer: q.selectedAnswer,
          flagged: q.flagged
        })),
        lastUpdated: new Date().toISOString()
      };

      // Always save to localStorage immediately (fast and free)
      localStorage.setItem('mcq-2023-progress', JSON.stringify(progressData));

      // Debounce Firestore saves to prevent quota exhaustion
      // Only save to Firestore every 10 seconds max
      if (examUser && examDb) {
        clearTimeout(firestoreSaveTimeout);
        firestoreSaveTimeout = setTimeout(async () => {
          try {
            await examDb.collection('users')
              .doc(examUser.uid)
              .collection('exams')
              .doc('mcq-2023')
              .set(progressData, { merge: true });
            console.log('[Exam] Progress saved to Firestore');
          } catch (error) {
            console.error('[Exam] Error saving to Firestore:', error);
          }
        }, 10000); // Wait 10 seconds before saving to Firestore
      }
    }

    // Load progress from Firestore
    async function loadProgressFromFirestore() {
      if (!examUser || !examDb) return;

      try {
        const doc = await examDb.collection('users')
          .doc(examUser.uid)
          .collection('exams')
          .doc('mcq-2023')
          .get();

        if (doc.exists) {
          const progress = doc.data();
          currentQuestionIndex = progress.currentQuestionIndex || 0;

          // Restore answers and flags
          if (progress.questions) {
            progress.questions.forEach(savedQ => {
              const question = examData.questions.find(q => q.id === savedQ.id);
              if (question) {
                question.selectedAnswer = savedQ.selectedAnswer;
                question.flagged = savedQ.flagged || false;
              }
            });
          }

          console.log('[Exam] Progress loaded from Firestore');

          // Regenerate navigation to show answered and flagged questions
          generateQuestionNav();

          loadQuestion(currentQuestionIndex);
        } else {
          // No Firestore data, check localStorage for migration
          loadProgress();
        }
      } catch (error) {
        console.error('[Exam] Error loading from Firestore:', error);
        loadProgress();
      }
    }

    // Load progress from localStorage
    function loadProgress() {
      const saved = localStorage.getItem('mcq-2023-progress');
      if (saved) {
        const progress = JSON.parse(saved);
        currentQuestionIndex = progress.currentQuestionIndex || 0;

        // Restore answers and flags
        if (progress.questions) {
          progress.questions.forEach(savedQ => {
            const question = examData.questions.find(q => q.id === savedQ.id);
            if (question) {
              question.selectedAnswer = savedQ.selectedAnswer;
              question.flagged = savedQ.flagged || false;
            }
          });
        }

        // Regenerate navigation to show answered and flagged questions
        generateQuestionNav();

        loadQuestion(currentQuestionIndex);
      }
    }

    // Function to return to exams modal
    function returnToExams() {
      // Try to force save but don't wait - navigate immediately
      forceSaveProgress().catch(err => console.error('[Exam] Save failed on exit:', err));

      // Navigate immediately (localStorage already has the data)
      window.location.href = '../index.html#past-exams';
    }

    // Calculate and show results
    function showResults() {
      saveCurrentAnswer();

      // Calculate statistics
      let answered = 0;
      let unanswered = 0;

      examData.questions.forEach(q => {
        if (q.selectedAnswer === null || q.selectedAnswer === undefined) {
          unanswered++;
        } else {
          answered++;
        }
      });

      // Show confirmation if there are unanswered questions
      if (unanswered > 0) {
        const confirmMessage = `You have ${unanswered} unanswered question${unanswered > 1 ? 's' : ''}. Are you sure you want to finish?`;
        if (!confirm(confirmMessage)) {
          return; // Don't submit if user cancels
        }
      }

      // Update modal content
      document.getElementById('answeredCount').textContent = answered;
      document.getElementById('unansweredCount').textContent = unanswered;

      // Show modal
      document.getElementById('resultsModal').classList.add('show');
    }

    // Enter review mode
    function enterReviewMode() {
      isReviewMode = true;
      document.getElementById('resultsModal').classList.remove('show');
      document.getElementById('reviewModeBanner').classList.add('show');
      document.getElementById('noAnswerNotice').classList.add('show');

      // Pause the timer
      pauseTimer();

      // Hide submit button and show finish review button
      document.getElementById('finishBtn').style.display = 'none';
      document.getElementById('finishReviewBtn').style.display = 'block';

      // Load first question in review mode
      loadQuestion(0);
    }

    // Exit review mode
    function exitReviewMode() {
      isReviewMode = false;
      document.getElementById('reviewModeBanner').classList.remove('show');
      document.getElementById('noAnswerNotice').classList.remove('show');
      document.getElementById('finishBtn').style.display = 'block';
      document.getElementById('finishReviewBtn').style.display = 'none';

      // Resume the timer
      resumeTimer();
    }

    // Reset exam
    function resetExam() {
      if (!confirm('Are you sure you want to reset the exam? All your answers will be lost.')) {
        return;
      }

      // Reset all answers
      examData.questions.forEach(q => {
        q.selectedAnswer = null;
        q.flagged = false;
      });

      // Clear saved progress
      localStorage.removeItem('mcq-2023-progress');

      // Clear Firestore if user is signed in
      if (examUser && examDb) {
        examDb.collection('users')
          .doc(examUser.uid)
          .collection('exams')
          .doc('mcq-2023')
          .delete()
          .catch(error => console.error('[Exam] Error deleting from Firestore:', error));
      }

      // Reset state
      currentQuestionIndex = 0;
      isReviewMode = false;

      // Hide modal and banners
      document.getElementById('resultsModal').classList.remove('show');
      document.getElementById('reviewModeBanner').classList.remove('show');
      document.getElementById('noAnswerNotice').classList.remove('show');
      document.getElementById('finishBtn').style.display = 'block';
      document.getElementById('finishReviewBtn').style.display = 'none';

      // Reload exam
      loadQuestion(0);
      generateQuestionNav();
    }

    // Event listeners
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentQuestionIndex > 0) {
        loadQuestion(currentQuestionIndex - 1);
      }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentQuestionIndex < examData.totalQuestions - 1) {
        loadQuestion(currentQuestionIndex + 1);
      }
    });

    document.getElementById('finishBtn').addEventListener('click', () => {
      showResults();
    });

    document.getElementById('backBtn').addEventListener('click', () => {
      returnToExams();
    });

    // Results modal button listeners
    document.getElementById('reviewAnswersBtn').addEventListener('click', () => {
      enterReviewMode();
    });

    document.getElementById('resetExamBtn2').addEventListener('click', () => {
      resetExam();
    });

    document.getElementById('backToExamsBtn').addEventListener('click', () => {
      returnToExams();
    });

    // Finish review button listener
    document.getElementById('finishReviewBtn').addEventListener('click', () => {
      returnToExams();
    });

    // Auto-save every 30 seconds
    setInterval(saveCurrentAnswer, 30000);

    // Save progress when user leaves the page
    window.addEventListener('beforeunload', async (e) => {
      await forceSaveProgress();
    });

    // Check for existing progress and show modal if needed
    function checkExistingProgress() {
      const saved = localStorage.getItem('mcq-2023-progress');
      if (saved) {
        const progress = JSON.parse(saved);
        // Check if there's any actual progress (selected answers)
        const hasProgress = progress.questions && progress.questions.some(q => q.selectedAnswer !== null && q.selectedAnswer !== undefined);

        if (hasProgress) {
          // Show modal
          const modal = document.getElementById('progressModal');
          modal.style.display = 'flex';

          // Handle continue button
          document.getElementById('continueExamBtn').addEventListener('click', () => {
            modal.style.display = 'none';
            initExam();
          });

          // Handle reset button
          document.getElementById('resetExamBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to reset this exam? All progress will be permanently deleted.')) {
              return;
            }

            // Clear Firestore first if available
            if (examUser && examDb) {
              try {
                await examDb.collection('users')
                  .doc(examUser.uid)
                  .collection('exams')
                  .doc('mcq-2023')
                  .delete();
                console.log('[Exam] Progress deleted from Firestore');
              } catch (error) {
                console.error('[Exam] Error deleting from Firestore:', error);
              }
            }

            // Clear localStorage
            localStorage.removeItem('mcq-2023-progress');
            localStorage.removeItem('mcq-2023-completed');

            // Reset exam data in memory
            examData.questions.forEach(q => {
              q.selectedAnswer = null;
              q.flagged = false;
            });

            currentQuestionIndex = 0;
            elapsedSeconds = 0;

            modal.style.display = 'none';

            // Reinitialize exam with fresh state
            generateQuestionNav();
            loadQuestion(0);
            startTimer();
          });

          return; // Don't auto-initialize
        }
      }

      // No progress found, initialize normally
      initExam();
    }

    // Initialize
    checkExistingProgress();
  </script>
</body>
</html>
