<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Debug Live Site</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .error { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
    .info { color: blue; }
    pre { background: #f5f5f5; padding: 10px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>Live Site Debug Report</h1>
  <div id="output"></div>

  <!-- Load all the same scripts as index.html -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script src="js/firebase-config.js"></script>
  <script src="js/core/EventBus.js"></script>
  <script src="js/core/FirebaseService.js"></script>
  <script src="js/core/App.js"></script>

  <script src="js/auth.js"></script>
  <script src="js/auth-ui.js"></script>

  <script src="js/modules/progress/CompletionModule.js"></script>
  <script src="js/modules/progress/CompletionUI.js"></script>
  <script src="js/modules/progress/FlagModule.js"></script>
  <script src="js/modules/progress/FlagUI.js"></script>

  <script src="js/navigation.js"></script>

  <!-- Create a fake case card to test -->
  <div style="margin-top: 30px;">
    <h2>Test Case Card:</h2>
    <a href="cases/case1_1.html" class="case-card cardiology">
      <h3>1.1 Hypertension</h3>
    </a>
  </div>

  <script>
    const output = document.getElementById('output');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.innerHTML = message;
      output.appendChild(div);
      console.log(message);
    }

    function runDiagnostics() {
      log('<h2>Step 1: Core Services</h2>');
      log('window.eventBus: ' + (window.eventBus ? '<span class="success">✓ EXISTS</span>' : '<span class="error">✗ MISSING</span>'));
      log('window.firebaseService: ' + (window.firebaseService ? '<span class="success">✓ EXISTS</span>' : '<span class="error">✗ MISSING</span>'));
      log('window.app: ' + (window.app ? '<span class="success">✓ EXISTS</span>' : '<span class="error">✗ MISSING</span>'));

      log('<h2>Step 2: App Initialization</h2>');
      if (window.app) {
        log('app.initialized: ' + (window.app.initialized ? '<span class="success">✓ TRUE</span>' : '<span class="error">✗ FALSE</span>'));
        log('app.modules: ' + JSON.stringify(Object.keys(window.app.modules || {})));
      }

      log('<h2>Step 3: Module Availability</h2>');
      log('window.CompletionModule: ' + (typeof window.CompletionModule !== 'undefined' ? '<span class="success">✓ LOADED</span>' : '<span class="error">✗ MISSING</span>'));
      log('window.CompletionUI: ' + (typeof window.CompletionUI !== 'undefined' ? '<span class="success">✓ LOADED</span>' : '<span class="error">✗ MISSING</span>'));
      log('window.FlagModule: ' + (typeof window.FlagModule !== 'undefined' ? '<span class="success">✓ LOADED</span>' : '<span class="error">✗ MISSING</span>'));
      log('window.FlagUI: ' + (typeof window.FlagUI !== 'undefined' ? '<span class="success">✓ LOADED</span>' : '<span class="error">✗ MISSING</span>'));

      log('<h2>Step 4: Module Instances</h2>');
      if (window.app && window.app.getModule) {
        const flag = window.app.getModule('flag');
        const flagUI = window.app.getModule('flagUI');
        const completion = window.app.getModule('completion');
        const completionUI = window.app.getModule('completionUI');

        log('app.getModule("flag"): ' + (flag ? '<span class="success">✓ EXISTS</span>' : '<span class="error">✗ NULL</span>'));
        log('app.getModule("flagUI"): ' + (flagUI ? '<span class="success">✓ EXISTS</span>' : '<span class="error">✗ NULL</span>'));
        log('app.getModule("completion"): ' + (completion ? '<span class="success">✓ EXISTS</span>' : '<span class="error">✗ NULL</span>'));
        log('app.getModule("completionUI"): ' + (completionUI ? '<span class="success">✓ EXISTS</span>' : '<span class="error">✗ NULL</span>'));

        log('<h2>Step 5: Test UI Methods</h2>');
        if (flagUI && typeof flagUI.updateAllCaseFlagIndicators === 'function') {
          log('Calling flagUI.updateAllCaseFlagIndicators()...');
          flagUI.updateAllCaseFlagIndicators();

          setTimeout(() => {
            const testCard = document.querySelector('.case-card');
            const bookmark = testCard ? testCard.querySelector('.case-flag-bookmark') : null;
            log('Bookmark created on test card: ' + (bookmark ? '<span class="success">✓ YES</span>' : '<span class="error">✗ NO</span>'));

            if (!bookmark && testCard) {
              log('<span class="error">ERROR: flagUI.updateAllCaseFlagIndicators() did not create bookmark!</span>', 'error');
              log('Test card HTML: <pre>' + testCard.innerHTML + '</pre>');
            }
          }, 1000);
        } else {
          log('<span class="error">flagUI.updateAllCaseFlagIndicators is not a function!</span>', 'error');
        }

        if (flagUI && typeof flagUI.updateAllFlaggedQuestionsBadges === 'function') {
          log('Calling flagUI.updateAllFlaggedQuestionsBadges()...');
          flagUI.updateAllFlaggedQuestionsBadges();
        }

        if (completionUI && typeof completionUI.updateAllCaseCompletionIndicators === 'function') {
          log('Calling completionUI.updateAllCaseCompletionIndicators()...');
          completionUI.updateAllCaseCompletionIndicators();
        }
      }

      log('<h2>Step 6: Check Case Cards on Page</h2>');
      const caseCards = document.querySelectorAll('.case-card');
      log('Total case cards found: ' + caseCards.length);

      if (caseCards.length > 0) {
        const firstCard = caseCards[0];
        log('First card href: ' + firstCard.getAttribute('href'));
        log('First card has bookmark: ' + (firstCard.querySelector('.case-flag-bookmark') ? 'YES' : 'NO'));
        log('First card HTML sample: <pre>' + firstCard.innerHTML.substring(0, 200) + '</pre>');
      }
    }

    // Wait for everything to load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(runDiagnostics, 3000);
      });
    } else {
      setTimeout(runDiagnostics, 3000);
    }

    // Also listen for app:ready event
    if (window.app) {
      window.app.on('app:ready', () => {
        log('<h2>✓ App Ready Event Fired!</h2>', 'success');
      });
    }
  </script>
</body>
</html>
